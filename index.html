<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jad≈Çospis dla Emila ‚Äì 4 tygodnie (makra %, nawigacja, zakupy)</title>
<style>
:root{--hdr:#1F4E78;--bg:#F8FAFC;--txt:#0F172A;--card:#FFFFFF;--br:#E5E7EB;
--s1:#FFF2CC;--s2:#D6EFD8;--s3:#DDEBF7;--s4:#FCE4D6;--s5:#E7E6E6;--sum:#C6EFCE;--accent:#3b82f6}
:root.dark{--hdr:#0B2447;--bg:#0B1220;--txt:#E5E7EB;--card:#0F172A;--br:#334155;
--s1:#33461a;--s2:#1d3b2a;--s3:#182e4a;--s4:#3a2d1a;--s5:#333;--sum:#164;--accent:#60a5fa}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial}
.header{background:var(--hdr);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;position:sticky;top:0;z-index:10}
h1{margin:0;font-size:18px}.sub{opacity:.9;font-size:12px}.controls{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid var(--br);background:#fff;color:#0b3b8a;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
:root.dark .btn{background:#0f172a;color:#93c5fd}.container{max-width:1200px;margin:16px auto;padding:0 10px}
.tabs,.subtabs{display:flex;gap:6px;flex-wrap:wrap}.tab,.subtab{padding:8px 12px;border-radius:999px;border:1px solid var(--br);background:#fff;color:#0b3b8a;font-weight:700;cursor:pointer}
:root.dark .tab,:root.dark .subtab{background:#0f172a;color:#93c5fd}.tab.active,.subtab.active{background:#eef2ff}
:root.dark .tab.active,:root.dark .subtab.active{background:#1e293b}.panel{display:none}.panel.active{display:block}
.card{background:var(--card);border:1px solid var(--br);border-radius:14px;margin:10px 0;overflow:hidden}
.card h2{margin:0;padding:10px 12px;color:#fff;background:linear-gradient(90deg,var(--hdr),#3a63aa);font-size:16px}
.table{width:100%;border-collapse:separate;border-spacing:0;min-width:920px}
.table th,.table td{padding:8px 10px;border-bottom:1px solid var(--br);text-align:center;vertical-align:middle}
.thead th{position:sticky;top:52px;background:#eef2ff;z-index:1}
.tr-sec th{text-align:left}
.sec-sniadanie th{background:var(--s1)}.sec-drugie th{background:var(--s2)}.sec-obiad th{background:var(--s3)}.sec-kolacja th{background:var(--s4)}.sec-jogurt th{background:var(--s5)}
.sum-row td{background:var(--sum);font-weight:700}.scroll{overflow:auto}
.motto{padding:10px 12px;background:#eef6ff;border-left:4px solid var(--accent);font-style:italic}:root.dark .motto{background:#0e1a2a;color:#93c5fd}
.pills{display:flex;flex-wrap:wrap;gap:6px;padding:8px;border-top:1px solid var(--br);background:#f9fafb}
:root.dark .pills{background:#0b1320}.pill{background:#ecfeff;border:1px solid #a5f3fc;color:#075985;padding:6px 8px;border-radius:999px;font-size:12px}
.pill.ok{border-color:#86efac;background:#ecfdf5;color:#166534}
.pill.warn{border-color:#fcd34d;background:#fffbeb;color:#92400e}
.pill.err{border-color:#fca5a5;background:#fef2f2;color:#991b1b}
.checklist{padding:8px 12px;background:#f8fafc;border-top:1px dashed var(--br)}.checklist h3{margin:6px 0 8px 0;font-size:14px}
.checklist ul{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:6px}
.checklist li{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid var(--br);border-radius:10px;background:#fff}
:root.dark .checklist li{background:#0f172a}.cost{font-weight:700}
.price-card td[contenteditable="true"]{outline:2px dashed transparent}.price-card td[contenteditable="true"]:focus{outline:2px dashed var(--accent);background:#eef6ff}
.printbar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
.badge{display:inline-block;background:#fff;border:1px dashed var(--br);padding:6px 10px;border-radius:8px;font-size:12px;margin:6px 0 0 10px}
.navday{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;border-top:1px dashed var(--br);background:#f8fafc}
.navday .btn{background:#eef2ff}
.small{font-size:12px;opacity:.85}
.controls .select{border-radius:10px;border:1px solid var(--br);padding:6px 10px;font-weight:700;background:#fff;color:#0b3b8a}
:root.dark .select{background:#0f172a;color:#93c5fd;border-color:#334155}
.chartWrap{display:flex;gap:16px;align-items:center;padding:10px 12px;border-top:1px dashed var(--br);flex-wrap:wrap}
.chartWrap canvas{max-width:180px;max-height:180px}
@media (max-width:700px){h1{font-size:16px}.table{min-width:680px}}
@media print{.header,.tabs,.subtabs,.price-card,.printbar,.navday,.filterbar{display:none}body{background:#fff;color:#000}.card{box-shadow:none;margin:6px 0}}
.print-mode-day .card.daycard{display:none}.print-mode-day .card.daycard.active{display:block}
.print-mode-week .panel{display:none}.print-mode-week .panel.active{display:block}
.print-mode-shopping .card:not(.shopping){display:none}
/* ======= MOBILE LOVE ======= */
.scroll{ -webkit-overflow-scrolling: touch; overscroll-behavior: contain; position:relative }
.scroll::before,.scroll::after{
  content:""; position:absolute; top:0; bottom:0; width:18px; pointer-events:none;
  transition:opacity .2s; opacity:0; z-index:1
}
/* Cache-Control: public, max-age=0, must-revalidate */
.scroll::before{ left:0; background:linear-gradient(90deg,var(--bg),rgba(255,255,255,0)) }
.scroll::after{ right:0; background:linear-gradient(270deg,var(--bg),rgba(255,255,255,0)) }
.scroll.show-left::before{ opacity:1 }
.scroll.show-right::after{ opacity:1 }

/* horyzontalny przewijak na sub-taby (dni) */
.subtabs{ overflow-x:auto; -webkit-overflow-scrolling:touch; gap:8px; padding-bottom:6px }
.subtabs::-webkit-scrollbar{ display:none }
.subtab{ flex:0 0 auto }

/* ‚Äûkafelki‚Äù te≈º przewijalne */
.tabs{ overflow-x:auto; -webkit-overflow-scrolling:touch }
.tabs::-webkit-scrollbar{ display:none }
.tab{ flex:0 0 auto }

/* przyciski ‚Äì wiƒôksze hitboxy na dotyk */
.btn{ min-height:40px }

/* wykres na telefonie mniejszy */
.chartWrap{ gap:10px }
.chartWrap canvas{ max-width:140px; max-height:140px }

/* checklist 1 kolumna na ma≈Çych ekranach */
@media (max-width: 560px){
  .header{ flex-direction:column; align-items:flex-start; gap:6px }
  .controls{ width:100% }
  .controls .btn, .controls .select{ flex:1 }
  .pills{ gap:8px }
  .pill{ font-size:11px }
  .table th,.table td{ padding:6px 8px; font-size:13px }
  .checklist ul{ grid-template-columns:1fr }
  .navday{ gap:6px }
  .navday .btn{ flex:1 }
  .badge{ display:block; margin-left:12px }
}

/* lepszy widok ‚ÄûTylko ≈õniadania/obiady‚Ä¶‚Äù ‚Äì ukryj puste nag≈Ç√≥wki */
tr.tr-sec[style*="display: none"] + tr.sum-row{ display:none !important }

/* przeniesione z bloku <script> ‚Äì styl cennika (maks. wysoko≈õƒá i brak "sticky" nag≈Ç√≥wka) */
.price-card details > .scroll{max-height:50vh; overflow:auto;}
.price-card .thead th{position:static;} /* bez przyklejonego nag≈Ç√≥wka w cenniku */
</style>
</head>
<body>
<div class="header">
  <div>
    <h1>Jad≈Çospis dla Emila</h1>
    <div class="sub">4 posi≈Çki + jogurt ‚Ä¢ cel 2800 kcal ‚Ä¢ bia≈Çko 75‚Äì85 g ‚Ä¢ ~50% t≈Çuszczu ‚Ä¢ ~30% wƒôgli ‚Ä¢ marki Lidl ‚Ä¢ makra w % ‚Ä¢ druk selektywny</div>
  </div>
  <div class="controls">
    <button class="btn" onclick="_toggleDark()">üåó Tryb ciemny</button>
    <select id="mealFilter" class="select">
      <option value="all">üîé Poka≈º: wszystko</option>
      <option value="sniadanie">‚òÄ Tylko ≈õniadania</option>
      <option value="drugie">ü•™ Tylko II ≈õniadania</option>
      <option value="obiad">üçΩ Tylko obiady</option>
      <option value="kolacja">üåô Tylko kolacje</option>
      <option value="jogurt">ü•õ Tylko jogurt</option>
    </select>
    <div class="printbar">
      <button id="pDay" class="btn">üñ® Drukuj: bie≈ºƒÖcy dzie≈Ñ</button>
      <button id="pWeek" class="btn">üñ® Drukuj: bie≈ºƒÖcy tydzie≈Ñ</button>
      <button id="pShop" class="btn">üñ® Drukuj: tylko zakupy</button>
      <button id="pAll" class="btn">üñ® Drukuj: wszystko</button>
      <button id="autoKcal" class="btn">‚ö° Auto 2800</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- ======== CENNIK (edytowalny) ======== -->
<div class="card price-card">
    <h2>üí∂ Cennik produkt√≥w (edytowalny)</h2>
    <details id="priceDetails" open>
  <summary style="padding:8px 12px;cursor:pointer;font-weight:700">
    Poka≈º / ukryj cennik
  </summary>
    <div class="scroll">
      <table id="priceTable" class="table">
        <thead class="thead"><tr><th>Klucz</th><th>Jednostka</th><th>Cena</th></tr></thead>
        <tbody>
          <tr data-key="borowki_250g"><td>borowki_250g</td><td>z≈Ç/250g</td><td class="pval" contenteditable="true">8.99</td></tr>
          <tr data-key="napoj_migdalowy_1l"><td>napoj_migdalowy_1l</td><td>z≈Ç/1l</td><td class="pval" contenteditable="true">6.49</td></tr>
          <tr data-key="salatka_chef_select_250g"><td>salatka_chef_select_250g</td><td>z≈Ç/250g</td><td class="pval" contenteditable="true">5.99</td></tr>
          <tr data-key="losos_filet_kg"><td>losos_filet_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">79.90</td></tr>
          <tr data-key="dorsz_filet_kg"><td>dorsz_filet_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">49.90</td></tr>
          <tr data-key="mintaj_filet_kg"><td>mintaj_filet_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">29.90</td></tr>
          <tr data-key="indyk_piers_kg"><td>indyk_piers_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">39.90</td></tr>
          <tr data-key="kurczak_piers_kg"><td>kurczak_piers_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">29.90</td></tr>
          <tr data-key="oliwa_extra_vergine_l_1"><td>oliwa_extra_vergine_l_1</td><td>z≈Ç/l</td><td class="pval" contenteditable="true">27.99</td></tr>
          <tr data-key="kasza_gryczana_1kg"><td>kasza_gryczana_1kg</td><td>z≈Ç/1kg</td><td class="pval" contenteditable="true">9.99</td></tr>
          <tr data-key="ryz_basmati_1kg"><td>ryz_basmati_1kg</td><td>z≈Ç/1kg</td><td class="pval" contenteditable="true">12.99</td></tr>
          <tr data-key="kuskus_1kg"><td>kuskus_1kg</td><td>z≈Ç/1kg</td><td class="pval" contenteditable="true">9.99</td></tr>
          <tr data-key="platki_owsiane_1kg"><td>platki_owsiane_1kg</td><td>z≈Ç/1kg</td><td class="pval" contenteditable="true">6.99</td></tr>
          <tr data-key="hummus_pojemnik_180g"><td>hummus_pojemnik_180g</td><td>z≈Ç/180g</td><td class="pval" contenteditable="true">5.49</td></tr>
          <tr data-key="jogurt_naturalny_200g"><td>jogurt_naturalny_200g</td><td>z≈Ç/200g</td><td class="pval" contenteditable="true">2.19</td></tr>
          <tr data-key="chleb_zytni_bochenek_700g"><td>chleb_zytni_bochenek_700g</td><td>z≈Ç/700g</td><td class="pval" contenteditable="true">6.99</td></tr>
          <tr data-key="ser_feta_kg"><td>ser_feta_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">39.90</td></tr>
          <tr data-key="twarog_poltl_kg"><td>twarog_poltl_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">19.90</td></tr>
          <tr data-key="orzechy_wloskie_kg"><td>orzechy_wloskie_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">49.90</td></tr>
          <tr data-key="migdaly_kg"><td>migdaly_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">59.90</td></tr>
          <tr data-key="pestki_dyni_kg"><td>pestki_dyni_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">29.90</td></tr>
          <tr data-key="awokado_szt"><td>awokado_szt</td><td>z≈Ç/szt</td><td class="pval" contenteditable="true">4.99</td></tr>
          <tr data-key="papryka_czerwona_kg"><td>papryka_czerwona_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">12.99</td></tr>
          <tr data-key="pomidor_kg"><td>pomidor_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">9.99</td></tr>
          <tr data-key="ogorek_kg"><td>ogorek_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">7.99</td></tr>
          <tr data-key="cebula_kg"><td>cebula_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">3.99</td></tr>
          <tr data-key="marchew_kg"><td>marchew_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">3.99</td></tr>
          <tr data-key="brokul_kg"><td>brokul_kg</td><td>z≈Ç/kg</td><td class="pval" contenteditable="true">9.99</td></tr>
          <tr data-key="kalafior_szt"><td>kalafior_szt</td><td>z≈Ç/szt</td><td class="pval" contenteditable="true">7.99</td></tr>
          <tr data-key="mix_warzyw_mroz_450g"><td>mix_warzyw_mroz_450g</td><td>z≈Ç/450g</td><td class="pval" contenteditable="true">6.49</td></tr>
          <tr data-key="jajka_10szt"><td>jajka_10szt</td><td>z≈Ç/10szt</td><td class="pval" contenteditable="true">12.99</td></tr>
        </tbody>
      </table>
    </div>
    </details>
    <div class="badge">üí° Edytuj ceny (PLN). Zapisywane lokalnie ‚Äì koszty i sumy zakup√≥w przeliczƒÖ siƒô same.</div>
  </div>  

  <!-- ======== ZAK≈ÅADKI TYGODNI ======== -->
  <div class="tabs" id="weekTabs"></div>
  <div id="weeksRoot"></div>

  <!-- ======== ZAKUPY ‚Äì wyb√≥r tygodnia ======== -->
  <div class="card shopping">
    <h2>üßæ Podsumowanie zakup√≥w tygodniowych</h2>
    <div id="shoppingWeeks" class="pills"></div>
    <div id="shoppingListWrap" style="padding:10px 12px"></div>
    <div class="small" style="padding:0 12px 10px">Kliknij tydzie≈Ñ powy≈ºej, by zobaczyƒá listƒô produkt√≥w i ≈ÇƒÖczny koszt.</div>
  </div>

</div>

<script>
/* ============ NUTRI DB (na 100 g) ============ */
const NUTRI = {
  maslo_orzechowe:{ brand:'McEnnedy/Alesto', kcal:600, p:25, f:50, c:20 },
  orzechy_nerkowca:{ brand:'Alesto', kcal:553, p:18, f:44, c:30 },
  slonecznik:{ brand:'Alesto', kcal:584, p:21, f:51, c:20 },
  siemie_lniane:{ brand:'Alesto', kcal:534, p:18, f:42, c:29 },
  banan: { brand:'Owoce ≈õwie≈ºe', kcal:89,  p:1.1, f:0.3, c:23 },
  jablko:{ brand:'Owoce ≈õwie≈ºe', kcal:52,  p:0.3, f:0.2, c:14 },
  borowki:{ brand:'Owoce ≈õwie≈ºe', kcal:57,  p:0.7, f:0.3, c:14 },
  jajko:  { brand:'-', kcal:143, p:12.6, f:10.6, c:0.7, priceKey:'jajka_10szt', unit:'szt', unitGram:50, pricePerUnit:true },
  oliwa:  { brand:'Primadonna Extra Vergine', kcal:884, p:0, f:100, c:0, priceKey:'oliwa_extra_vergine_l_1' },
  chleb_zytni:{ brand:'Piekarnia Lidl ‚Äì ≈ºytni', kcal:220, p:6, f:1.5, c:43, priceKey:'chleb_zytni_bochenek_700g' },
  papryka:{ brand:'Warzywa ≈õwie≈ºe', kcal:31, p:1, f:0.3, c:6, priceKey:'papryka_czerwona_kg' },
  ogorek: { brand:'Warzywa ≈õwie≈ºe', kcal:15, p:0.7, f:0.1, c:3.6, priceKey:'ogorek_kg' },
  pomidor:{ brand:'Warzywa ≈õwie≈ºe', kcal:18, p:0.9, f:0.2, c:3.9, priceKey:'pomidor_kg' },
  cebula: { brand:'Warzywa ≈õwie≈ºe', kcal:40, p:1.1, f:0.1, c:9.3, priceKey:'cebula_kg' },
  marchew:{ brand:'Warzywa ≈õwie≈ºe', kcal:41, p:0.9, f:0.2, c:10, priceKey:'marchew_kg' },
  mix_mroz:{ brand:'Mro≈ºone (marchew+broku≈Ç+kalafior)', kcal:34, p:2.5, f:0.4, c:5.9, priceKey:'mix_warzyw_mroz_450g', packed:450 },
  hummus: { brand:'Vemondo', kcal:240, p:7, f:18, c:13, priceKey:'hummus_pojemnik_180g', packed:180 },
  jogurt2:{ brand:'Pilos 2%', kcal:62, p:4, f:2, c:5, priceKey:'jogurt_naturalny_200g', packed:200 },
  feta:   { brand:'Pilos/Eridanous', kcal:265, p:14.2, f:21.5, c:3.9, priceKey:'ser_feta_kg' },
  twarog: { brand:'Pilos', kcal:132, p:18, f:6, c:3.4, priceKey:'twarog_poltl_kg' },
  orzechy_wloskie:{ brand:'Alesto', kcal:654, p:15, f:65, c:14, priceKey:'orzechy_wloskie_kg' },
  migdaly:{ brand:'Alesto', kcal:579, p:21, f:50, c:22, priceKey:'migdaly_kg' },
  pestki_dyni:{ brand:'Alesto', kcal:559, p:30, f:49, c:11, priceKey:'pestki_dyni_kg' },
  platki_owsiane:{ brand:'Crownfield', kcal:371, p:12.5, f:7, c:60, priceKey:'platki_owsiane_1kg' },
  kasza_gryczana_sucha:{ brand:'Golden Sun', kcal:346, p:13, f:3, c:69, priceKey:'kasza_gryczana_1kg' },
  ryz_basmati_suchy:   { brand:'Golden Sun', kcal:360, p:7.1, f:0.6, c:79, priceKey:'ryz_basmati_1kg' },
  kuskus_suchy:        { brand:'Golden Sun', kcal:376, p:12, f:0.6, c:77, priceKey:'kuskus_1kg' },
  // bia≈Çka
  dorsz:  { brand:'Rybak Morski', kcal:82, p:18, f:0.7, c:0, priceKey:'dorsz_filet_kg' },
  mintaj: { brand:'Ocean Sea',    kcal:90, p:17, f:2,   c:0, priceKey:'mintaj_filet_kg' },
  losos:  { brand:'Rybak Morski', kcal:208,p:20, f:13,  c:0, priceKey:'losos_filet_kg' },
  indyk:  { brand:'Piƒôkna Kurka', kcal:105,p:23, f:1.5, c:0, priceKey:'indyk_piers_kg' },
  kurczak:{ brand:'Kania',        kcal:120,p:22, f:2.6, c:0, priceKey:'kurczak_piers_kg' },
  awokado:{ brand:'Owoce', kcal:160, p:2, f:15, c:9, priceKey:'awokado_szt', unit:'szt', unitGram:180, pricePerUnit:true },
// ===== Aliasowanie brakujƒÖcych kluczy z PLAN do NUTRI =====
}; // zamknij literal NUTRI po wcze≈õniejszych wpisach
NUTRI.borowki = { brand:'Owoce ≈õwie≈ºe', kcal:57, p:0.7, f:0.3, c:14, priceKey:'borowki_250g', packed:250 };
NUTRI.napoj_migdalowy = { brand:'Vemondo', kcal:15, p:0.5, f:1.1, c:0.3, priceKey:'napoj_migdalowy_1l', packed:1000 };
NUTRI.salatka_chef_select = { brand:'Chef Select', kcal:25, p:1.5, f:0.3, c:4, priceKey:'salatka_chef_select_250g', packed:250 };
NUTRI.napoj_migdalowy = NUTRI.napoj_migdalowy || { brand:'Vemondo', kcal:15, p:0.5, f:1.1, c:0.3 }; // nap√≥j migda≈Çowy ~15 kcal/100g
NUTRI.jogurt_nat      = NUTRI.jogurt2;         // alias: jogurt naturalny 2%
NUTRI.orzechy_mix     = NUTRI.orzechy_wloskie; // alias: mix ‚Üí orzechy w≈Çoskie
NUTRI.hummus_chef_select = NUTRI.hummus;       // alias: hummus
NUTRI.warzywa_mrozone = NUTRI.mix_mroz;        // alias: mro≈ºony mix
NUTRI.pasta_vemondo   = NUTRI.hummus;          // proxy: pasta ‚Üí hummus
NUTRI.jajka           = NUTRI.jajko;           // alias: ‚Äûjajka‚Äù ‚Üí ‚Äûjajko‚Äù

// Bulgur (suchy) ‚Äì dodajemy zbli≈ºone warto≈õci i cenƒô jak kuskus
NUTRI.bulgur_suchy = NUTRI.bulgur_suchy || { brand:'Golden Sun', kcal:342, p:12, f:1.3, c:75, priceKey:'kuskus_1kg' };

// Sa≈Çatka Chef Select ‚Äì lekka mieszanka (przybli≈ºenie)
NUTRI.salatka_chef_select = NUTRI.salatka_chef_select || { brand:'Chef Select', kcal:25, p:1.5, f:0.3, c:4, /* brak priceKey => koszt=0 */ };

// Bezpieczny fallback: je≈õli kiedy≈õ pojawi siƒô nowy klucz, niech siƒô nie wy≈Ço≈ºy
function safeNutri(k){ return NUTRI[k] || null; }

/* ============ CENY ‚Äì odczyt/zapis ============ */
const PRICE_STORE_KEY = 'emil_prices_v2';
function loadPrices(){
  const saved = localStorage.getItem(PRICE_STORE_KEY);
  let map = {};
  if(saved){ try{ map = JSON.parse(saved) || {} }catch(e){} }
  document.querySelectorAll('#priceTable tbody tr').forEach(tr=>{
    const key = tr.getAttribute('data-key');
    const val = parseFloat(tr.querySelector('.pval').textContent.replace(',','.'))||0;
    if(!(key in map)) map[key]=val;
  });
  return map;
}
function savePrices(){
  const map={};
  document.querySelectorAll('#priceTable tbody tr').forEach(tr=>{
    const key = tr.getAttribute('data-key');
    const val = parseFloat(tr.querySelector('.pval').textContent.replace(',','.'))||0;
    map[key]=val;
  });
  try{ localStorage.setItem(PRICE_STORE_KEY, JSON.stringify(map)); }catch(e){}
}

// styles for .price-card were moved to the <style> block in the document head

// sync UI edits to storage and re-render
document.addEventListener('input', e=>{
  if(e.target.matches('.price-card .pval')) { savePrices(); renderAll(); }
});
/* ============ POMOCNICZE ============ */
const kcalFromMacros = (p,f,c)=> (p*4 + f*9 + c*4);
const pct = (num,den)=> den>0 ? Math.round((num/den)*100) : 0;
const fmt = n => (Math.round(n*100)/100).toFixed(2);

/* ============ KOSZT jednostkowy ============ */
function priceFor(ingKey, grams, prices){
  const nd = NUTRI[ingKey]; if(!nd || !nd.priceKey) return 0;
  const price = prices[nd.priceKey] ?? 0;

  if(nd.pricePerUnit && nd.unit==='szt'){
    const perGram = price / (nd.unitGram || grams || 1);
    return perGram * grams;
  }
  if(nd.priceKey==='oliwa_extra_vergine_l_1'){ // 1 l ~ 1000 g (upraszczamy do przelicze≈Ñ)
    return (price/1000) * grams;
  }
  if(nd.packed){ return (price / nd.packed) * grams; }
  if(nd.priceKey.endsWith('_1kg') || nd.priceKey.endsWith('_kg')) return (price/1000) * grams;
  if(nd.priceKey.endsWith('_700g')) return (price/700) * grams;
  if(nd.priceKey.endsWith('_450g')) return (price/450) * grams;
  if(nd.priceKey.endsWith('_200g')) return (price/200) * grams;
  if(nd.priceKey.endsWith('_180g')) return (price/180) * grams;
  if(nd.priceKey.endsWith('_10szt')){
    const perEgg = price/10, perGram = perEgg/(nd.unitGram||50);
    return perGram*grams;
  }
  if(nd.priceKey.endsWith('_szt')){
    return (price/(nd.unitGram||180))*grams;
  }
  return 0;
}

/* ============ OBLICZENIA pozycji ============ */
function computeItem(ingKey, grams, labelOverride){
  
  const nd = NUTRI[ingKey]; if(!nd) return null;
  const ratio = grams/100;
  const p = +(nd.p*ratio).toFixed(1);
  const f = +(nd.f*ratio).toFixed(1);
  const c = +(nd.c*ratio).toFixed(1);
  const kcal = Math.round(kcalFromMacros(p,f,c));
  return { key:ingKey, brand:nd.brand||'-', label:labelOverride || ingKey, grams, kcal, p, f, c };
}

/* ============ NAZWY POSI≈ÅK√ìW ============ */
const MEAL_NAMES = {
  sniadanie:'‚òÄ ≈öniadanie',
  drugie:'ü•™ II ≈õniadanie',
  obiad:'üçΩ Obiad',
  kolacja:'üåô Kolacja',
  jogurt:'ü•õ Jogurt',
  podwieczorek:'ü•ó Podwieczorek'
};

/* ============ PLAN ‚Äì 4 tygodnie (28 dni) ============ */
/* Format: ka≈ºdy posi≈Çek = items[] + makra + SUMA DNIA.
   Za≈Ço≈ºenia tygodniowe: 6x ryba na obiad + 1x miƒôso (indyk). Produkty jak w li≈õcie.
   Uwaga: w TYG.2‚Äì4 ≈õniadania sƒÖ zr√≥≈ºnicowane; makra ≈õniadania pozostajƒÖ jak w bazie,
   ≈ºeby nie zmieniaƒá dziennych sum. */

/* ========== TYDZIE≈É 1 ‚Äì BEZ ZMIAN (TW√ìJ ORYGINA≈Å) ========== */
const PLAN = {
  week1:{ title:'üìò Tydzie≈Ñ 1', days:[
    {day:'Dzie≈Ñ 1',motto:'‚ÄûProsto, sycƒÖco i stabilnie.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70,l:'Owsianka (p≈Çatki)'},{k:'napoj_migdalowy',g:250,l:'Nap√≥j migda≈Çowy'},{k:'borowki',g:100,l:'Bor√≥wki'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150,l:'Jogurt naturalny'},{k:'orzechy_mix',g:40,l:'Orzechy mix'}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100,l:'Hummus Chef Select'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'},{k:'papryka',g:100,l:'Papryka'}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80,l:'Dorsz'},{k:'bulgur_suchy',g:40,l:'Bulgur (suchy)'},{k:'warzywa_mrozone',g:200,l:'Warzywa mro≈ºone'},{k:'oliwa',g:25,l:'Oliwa'}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250,l:'Sa≈Çatka Chef Select'},{k:'awokado',g:120,l:'Awokado'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80,l:'Pasta Vemondo'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pomidor',g:150,l:'Pomidor'},{k:'oliwa',g:15,l:'Oliwa'},{k:'pestki_dyni',g:25,l:'Pestki dyni'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 2',motto:'‚ÄûPowt√≥rka ‚Äì bo regularno≈õƒá dzia≈Ça.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70,l:'Owsianka (p≈Çatki)'},{k:'napoj_migdalowy',g:250,l:'Nap√≥j migda≈Çowy'},{k:'borowki',g:100,l:'Bor√≥wki'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150,l:'Jogurt naturalny'},{k:'orzechy_mix',g:40,l:'Orzechy mix'}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100,l:'Hummus Chef Select'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'},{k:'papryka',g:100,l:'Papryka'}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80,l:'Dorsz'},{k:'bulgur_suchy',g:40,l:'Bulgur (suchy)'},{k:'warzywa_mrozone',g:200,l:'Warzywa mro≈ºone'},{k:'oliwa',g:25,l:'Oliwa'}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250,l:'Sa≈Çatka Chef Select'},{k:'awokado',g:120,l:'Awokado'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80,l:'Pasta Vemondo'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pomidor',g:150,l:'Pomidor'},{k:'oliwa',g:15,l:'Oliwa'},{k:'pestki_dyni',g:25,l:'Pestki dyni'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 3',motto:'‚ÄûDelikatna zmiana: ≈Çoso≈õ na obiad.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70,l:'Owsianka (p≈Çatki)'},{k:'napoj_migdalowy',g:250,l:'Nap√≥j migda≈Çowy'},{k:'borowki',g:100,l:'Bor√≥wki'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150,l:'Jogurt naturalny'},{k:'orzechy_mix',g:40,l:'Orzechy mix'}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100,l:'Hummus Chef Select'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'},{k:'papryka',g:100,l:'Papryka'}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80,l:'≈Åoso≈õ'},{k:'bulgur_suchy',g:40,l:'Bulgur (suchy)'},{k:'warzywa_mrozone',g:200,l:'Warzywa mro≈ºone'},{k:'oliwa',g:25,l:'Oliwa'}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250,l:'Sa≈Çatka Chef Select'},{k:'awokado',g:120,l:'Awokado'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80,l:'Pasta Vemondo'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pomidor',g:150,l:'Pomidor'},{k:'oliwa',g:15,l:'Oliwa'},{k:'pestki_dyni',g:25,l:'Pestki dyni'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 4',motto:'‚ÄûDla odmiany: indyk na obiad.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70,l:'Owsianka (p≈Çatki)'},{k:'napoj_migdalowy',g:250,l:'Nap√≥j migda≈Çowy'},{k:'borowki',g:100,l:'Bor√≥wki'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150,l:'Jogurt naturalny'},{k:'orzechy_mix',g:40,l:'Orzechy mix'}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100,l:'Hummus Chef Select'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'},{k:'papryka',g:100,l:'Papryka'}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'indyk',g:80,l:'Indyk'},{k:'bulgur_suchy',g:40,l:'Bulgur (suchy)'},{k:'warzywa_mrozone',g:200,l:'Warzywa mro≈ºone'},{k:'oliwa',g:25,l:'Oliwa'}], kcal:554.2,b:25.6,w:42.8,t:29.4 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250,l:'Sa≈Çatka Chef Select'},{k:'awokado',g:120,l:'Awokado'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80,l:'Pasta Vemondo'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pomidor',g:150,l:'Pomidor'},{k:'oliwa',g:15,l:'Oliwa'},{k:'pestki_dyni',g:25,l:'Pestki dyni'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2872.6,b:87.9,w:244.2,t:170}},

    {day:'Dzie≈Ñ 5',motto:'‚ÄûKonsekwencja w prostych wyborach.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70,l:'Owsianka (p≈Çatki)'},{k:'napoj_migdalowy',g:250,l:'Nap√≥j migda≈Çowy'},{k:'borowki',g:100,l:'Bor√≥wki'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150,l:'Jogurt naturalny'},{k:'orzechy_mix',g:40,l:'Orzechy mix'}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100,l:'Hummus Chef Select'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'},{k:'papryka',g:100,l:'Papryka'}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'mintaj',g:80,l:'Mintaj'},{k:'bulgur_suchy',g:40,l:'Bulgur (suchy)'},{k:'warzywa_mrozone',g:200,l:'Warzywa mro≈ºone'},{k:'oliwa',g:25,l:'Oliwa'}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250,l:'Sa≈Çatka Chef Select'},{k:'awokado',g:120,l:'Awokado'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80,l:'Pasta Vemondo'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pomidor',g:150,l:'Pomidor'},{k:'oliwa',g:15,l:'Oliwa'},{k:'pestki_dyni',g:25,l:'Pestki dyni'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 6',motto:'‚ÄûWiƒôcej t≈Çuszczu z ryby ‚Äì ≈Çoso≈õ.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70,l:'Owsianka (p≈Çatki)'},{k:'napoj_migdalowy',g:250,l:'Nap√≥j migda≈Çowy'},{k:'borowki',g:100,l:'Bor√≥wki'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150,l:'Jogurt naturalny'},{k:'orzechy_mix',g:40,l:'Orzechy mix'}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100,l:'Hummus Chef Select'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'},{k:'papryka',g:100,l:'Papryka'}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80,l:'≈Åoso≈õ'},{k:'bulgur_suchy',g:40,l:'Bulgur (suchy)'},{k:'warzywa_mrozone',g:200,l:'Warzywa mro≈ºone'},{k:'oliwa',g:25,l:'Oliwa'}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250,l:'Sa≈Çatka Chef Select'},{k:'awokado',g:120,l:'Awokado'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80,l:'Pasta Vemondo'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pomidor',g:150,l:'Pomidor'},{k:'oliwa',g:15,l:'Oliwa'},{k:'pestki_dyni',g:25,l:'Pestki dyni'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 7',motto:'‚ÄûNiedzielna regeneracja ‚Äì ryba i warzywa.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70,l:'Owsianka (p≈Çatki)'},{k:'napoj_migdalowy',g:250,l:'Nap√≥j migda≈Çowy'},{k:'borowki',g:100,l:'Bor√≥wki'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150,l:'Jogurt naturalny'},{k:'orzechy_mix',g:40,l:'Orzechy mix'}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100,l:'Hummus Chef Select'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'},{k:'papryka',g:100,l:'Papryka'}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80,l:'Dorsz'},{k:'bulgur_suchy',g:40,l:'Bulgur (suchy)'},{k:'warzywa_mrozone',g:200,l:'Warzywa mro≈ºone'},{k:'oliwa',g:25,l:'Oliwa'}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250,l:'Sa≈Çatka Chef Select'},{k:'awokado',g:120,l:'Awokado'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80,l:'Pasta Vemondo'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pomidor',g:150,l:'Pomidor'},{k:'oliwa',g:15,l:'Oliwa'},{k:'pestki_dyni',g:25,l:'Pestki dyni'},{k:'chleb_zytni',g:40,l:'Chleb ≈ºytni'}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Zakupy_T1',motto:'Lista zbiorcza dla Tygodnia 1',shopping:true}
  ]},

  /* ========== TYDZIE≈É 2 ‚Äì ≈öNIADANIA UROZMAICONE ========== */
  week2:{ title:'üìò Tydzie≈Ñ 2', days:[
    {day:'Dzie≈Ñ 1',motto:'‚ÄûStart spokojny ‚Äì kanapki z hummusem.‚Äù',meals:{
      sniadanie:{ items:[{k:'chleb_zytni',g:80,l:'Chleb ≈ºytni'},{k:'hummus_chef_select',g:40,l:'Hummus Chef Select'},{k:'ogorek',g:100,l:'Og√≥rek'},{k:'pestki_dyni',g:10,l:'Pestki dyni'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 2',motto:'‚ÄûJajka + pieczywo + pomidor.‚Äù',meals:{
      sniadanie:{ items:[{k:'jajka',g:100,l:'Jajka 2 szt.'},{k:'chleb_zytni',g:60,l:'Chleb ≈ºytni'},{k:'pomidor',g:150,l:'Pomidor'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 3',motto:'‚ÄûTwar√≥g na ≈õniadanie.‚Äù',meals:{
      sniadanie:{ items:[{k:'twarog',g:150,l:'Twar√≥g p√≥≈Çt≈Çusty'},{k:'chleb_zytni',g:60,l:'Chleb ≈ºytni'},{k:'ogorek',g:100,l:'Og√≥rek'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'mintaj',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 4',motto:'‚ÄûOwsianka z bor√≥wkami.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70},{k:'napoj_migdalowy',g:250},{k:'borowki',g:100}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'indyk',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:554.2,b:25.6,w:42.8,t:29.4 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2872.6,b:87.9,w:244.2,t:170}},

    {day:'Dzie≈Ñ 5',motto:'‚ÄûKanapki z pastƒÖ Vemondo.‚Äù',meals:{
      sniadanie:{ items:[{k:'chleb_zytni',g:80},{k:'pasta_vemondo',g:50,l:'Pasta Vemondo'},{k:'pomidor',g:120},{k:'ogorek',g:80}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 6',motto:'‚ÄûTwar√≥g + pestki dyni.‚Äù',meals:{
      sniadanie:{ items:[{k:'twarog',g:150},{k:'chleb_zytni',g:60},{k:'pestki_dyni',g:10}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 7',motto:'‚ÄûJajka + awokado (kanapki).‚Äù',meals:{
      sniadanie:{ items:[{k:'jajka',g:100},{k:'chleb_zytni',g:60},{k:'awokado',g:60}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Zakupy_T2',motto:'Lista zbiorcza dla Tygodnia 2',shopping:true}
  ]},

  /* ========== TYDZIE≈É 3 ‚Äì ≈öNIADANIA UROZMAICONE ========== */
  week3:{ title:'üìò Tydzie≈Ñ 3', days:[
    {day:'Dzie≈Ñ 1',motto:'‚ÄûKanapki: feta + pomidor.‚Äù',meals:{
      sniadanie:{ items:[{k:'chleb_zytni',g:80},{k:'feta',g:30,l:'Feta'},{k:'pomidor',g:150}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 2',motto:'‚ÄûOwsianka bazowa (raz na tydzie≈Ñ).‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70},{k:'napoj_migdalowy',g:250},{k:'borowki',g:100}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 3',motto:'‚ÄûJajecznica (bez dodatku mleka).‚Äù',meals:{
      sniadanie:{ items:[{k:'jajka',g:100},{k:'chleb_zytni',g:60},{k:'cebula',g:30,l:'Cebula'}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'indyk',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:554.2,b:25.6,w:42.8,t:29.4 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2872.6,b:87.9,w:244.2,t:170}},

    {day:'Dzie≈Ñ 4',motto:'‚ÄûKanapki: hummus + og√≥rek.‚Äù',meals:{
      sniadanie:{ items:[{k:'chleb_zytni',g:80},{k:'hummus_chef_select',g:40},{k:'ogorek',g:120}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 5',motto:'‚ÄûOwsianka (rotacja raz/tydz.).‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70},{k:'napoj_migdalowy',g:250},{k:'borowki',g:100}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'mintaj',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 6',motto:'‚ÄûJajka + chleb + og√≥rek.‚Äù',meals:{
      sniadanie:{ items:[{k:'jajka',g:100},{k:'chleb_zytni',g:60},{k:'ogorek',g:120}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 7',motto:'‚ÄûKanapki: twar√≥g + pomidor.‚Äù',meals:{
      sniadanie:{ items:[{k:'twarog',g:150},{k:'chleb_zytni',g:60},{k:'pomidor',g:150}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Zakupy_T3',motto:'Lista zbiorcza dla Tygodnia 3',shopping:true}
  ]},

  /* ========== TYDZIE≈É 4 ‚Äì ≈öNIADANIA UROZMAICONE ========== */
  week4:{ title:'üìò Tydzie≈Ñ 4', days:[
    {day:'Dzie≈Ñ 1',motto:'‚ÄûKanapki: hummus + papryka.‚Äù',meals:{
      sniadanie:{ items:[{k:'chleb_zytni',g:80},{k:'hummus_chef_select',g:40},{k:'papryka',g:120}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 2',motto:'‚ÄûOwsianka klasyczna.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70},{k:'napoj_migdalowy',g:250},{k:'borowki',g:100}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 3',motto:'‚ÄûJajka + awokado (tosty).‚Äù',meals:{
      sniadanie:{ items:[{k:'jajka',g:100},{k:'chleb_zytni',g:60},{k:'awokado',g:60}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'mintaj',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 4',motto:'‚ÄûKanapki: twar√≥g + og√≥rek.‚Äù',meals:{
      sniadanie:{ items:[{k:'twarog',g:150},{k:'chleb_zytni',g:60},{k:'ogorek',g:120}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'losos',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:612.6,b:24.8,w:42.8,t:35.8 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2931,b:87.1,w:244.2,t:176.4}},

    {day:'Dzie≈Ñ 5',motto:'‚ÄûOwsianka z bor√≥wkami.‚Äù',meals:{
      sniadanie:{ items:[{k:'platki_owsiane',g:70},{k:'napoj_migdalowy',g:250},{k:'borowki',g:100}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}},

    {day:'Dzie≈Ñ 6',motto:'‚ÄûJajka + chleb + papryka.‚Äù',meals:{
      sniadanie:{ items:[{k:'jajka',g:100},{k:'chleb_zytni',g:60},{k:'papryka',g:120}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'indyk',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:554.2,b:25.6,w:42.8,t:29.4 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2872.6,b:87.9,w:244.2,t:170}},

    {day:'Dzie≈Ñ 7',motto:'‚ÄûKanapki: feta + og√≥rek.‚Äù',meals:{
      sniadanie:{ items:[{k:'chleb_zytni',g:80},{k:'feta',g:30},{k:'ogorek',g:100}], kcal:377.4,b:11.1,w:63.5,t:8 },
      jogurt:{ items:[{k:'jogurt_nat',g:150},{k:'orzechy_mix',g:40}], kcal:350,b:13.5,w:11.6,t:27.8 },
      drugie:{ items:[{k:'hummus_chef_select',g:100},{k:'chleb_zytni',g:40},{k:'papryka',g:100}], kcal:395,b:10.7,w:35.2,t:21.9 },
      obiad:{ items:[{k:'dorsz',g:80},{k:'bulgur_suchy',g:40},{k:'warzywa_mrozone',g:200},{k:'oliwa',g:25}], kcal:515.8,b:24,w:42.8,t:26 },
      podwieczorek:{ items:[{k:'salatka_chef_select',g:250},{k:'awokado',g:120},{k:'chleb_zytni',g:40}], kcal:584,b:12.6,w:51.8,t:38.6 },
      kolacja:{ items:[{k:'pasta_vemondo',g:80},{k:'ogorek',g:100},{k:'pomidor',g:150},{k:'oliwa',g:15},{k:'pestki_dyni',g:25},{k:'chleb_zytni',g:40}], kcal:612,b:14.4,w:39.3,t:44.3 }
    }, suma_dnia:{kcal:2834.2,b:86.3,w:244.2,t:166.6}}
  ]} 
};
/* ======= KONIEC PLAN ======= */

/* ============ RENDER TABELI DNIA ============ */

/* ‚Äî‚Äî‚Äî Statusy ‚Äûkcal‚Äù i ‚Äûmakra‚Äù ‚Äî‚Äî‚Äî */
function updateKcalStatus(card, dayK){
  const target = 2800;
  const tolOK = 100;    // ¬±100 kcal = OK
  const tolWarn = 200;  // ¬±200 kcal = WARN
  const el = card.querySelector('.kcal-status');
  if(!el) return;
  const diff = Math.round(dayK - target);
  let txt;
  if (diff === 0) txt = 'idealnie';
  else if (diff > 0) txt = '+' + diff + ' kcal';
  else txt = diff + ' kcal';

  if (Math.abs(diff) <= tolOK){
    el.textContent = txt + ' ‚Ä¢ w punkt!';
    el.parentElement.classList.remove('warn','err');
    el.parentElement.classList.add('ok');
  } else if (Math.abs(diff) <= tolWarn){
    el.textContent = txt + ' ‚Ä¢ bardzo blisko';
    el.parentElement.classList.remove('ok','err');
    el.parentElement.classList.add('warn');
  } else {
    el.textContent = txt + ' ‚Ä¢ rozjazd';
    el.parentElement.classList.remove('ok','warn');
    el.parentElement.classList.add('err');
  }
}

function updateMacroStatus(card, p, f, c){
  const kcalP = p*4, kcalF = f*9, kcalC = c*4;
  const tot = Math.max(kcalP+kcalF+kcalC, 1);
  const pctP = Math.round(kcalP/tot*100);
  const pctF = Math.round(kcalF/tot*100);
  const pctC = Math.round(kcalC/tot*100);
  const el = card.querySelector('.macro-status');
  if(!el) return;
  const okP = Math.abs(pctP-20)<=3;
  const okF = Math.abs(pctF-50)<=5;
  const okC = Math.abs(pctC-30)<=5;
  el.textContent = `B ${pctP}%, T ${pctF}%, W ${pctC}%`;
  const pill = el.parentElement;
  pill.classList.remove('ok','warn','err');
  if(okP && okF && okC) pill.classList.add('ok');
  else if((okP?1:0)+(okF?1:0)+(okC?1:0) >= 2) pill.classList.add('warn');
  else pill.classList.add('err');
}

/* ‚Äî‚Äî‚Äî Przeliczanie i ceny w ca≈Çym UI ‚Äî‚Äî‚Äî */
function computeSumsAndPrices(){
  const prices = loadPrices();

  document.querySelectorAll('.card.daycard').forEach(card=>{
    let dayK=0, dayP=0, dayF=0, dayC=0, dayCost=0;
    const secSums = {}; // {sec:{k,p,f,c,cost}}

    card.querySelectorAll('tbody tr').forEach(tr=>{
      const sec = tr.getAttribute('data-sec');
      if(!sec) return;

      secSums[sec] ||= {k:0,p:0,f:0,c:0,cost:0};

      const kcal = +tr.querySelector('.kcal')?.textContent||0;
      const p    = +tr.querySelector('.p')?.textContent||0;
      const f    = +tr.querySelector('.f')?.textContent||0;
      const c    = +tr.querySelector('.c')?.textContent||0;

      const span = tr.querySelector('.row-price');
      if(span){
        const k = span.getAttribute('data-k');
        const g = +(span.getAttribute('data-g')||0);
        const cost = priceFor(k, g, prices);
        span.textContent = cost ? fmt(cost)+' z≈Ç' : '‚Äî';
        secSums[sec].cost += cost;
        dayCost += cost;
      }

      secSums[sec].k += kcal;  secSums[sec].p += p;
      secSums[sec].f += f;     secSums[sec].c += c;

      dayK += kcal; dayP += p; dayF += f; dayC += c;
    });

    // wpisz sumy sekcji
    Object.entries(secSums).forEach(([sec,sum])=>{
      const row = card.querySelector(`.sum-row[data-sum="${sec}"]`);
      if(!row) return;
      row.querySelector('.sum-kcal').textContent = Math.round(sum.k);
      row.querySelector('.sum-p').textContent    = fmt(sum.p);
      row.querySelector('.sum-f').textContent    = fmt(sum.f);
      row.querySelector('.sum-c').textContent    = fmt(sum.c);

      const tot = sum.p*4 + sum.f*9 + sum.c*4 || 1;
      row.querySelector('.sum-pctp').textContent = Math.round((sum.p*4)/tot*100)+'%';
      row.querySelector('.sum-pctf').textContent = Math.round((sum.f*9)/tot*100)+'%';
      row.querySelector('.sum-pctc').textContent = Math.round((sum.c*4)/tot*100)+'%';

      row.querySelector('.sum-cost').textContent = sum.cost ? fmt(sum.cost)+' z≈Ç' : '‚Äî';
    });

    // suma dnia
    card.querySelector('.day-kcal').textContent = Math.round(dayK);
    card.querySelector('.day-p').textContent    = fmt(dayP);
    card.querySelector('.day-f').textContent    = fmt(dayF);
    card.querySelector('.day-c').textContent    = fmt(dayC);

    const totDay = dayP*4 + dayF*9 + dayC*4 || 1;
    card.querySelector('.day-pctp').textContent = Math.round((dayP*4)/totDay*100)+'%';
    card.querySelector('.day-pctf').textContent = Math.round((dayF*9)/totDay*100)+'%';
    card.querySelector('.day-pctc').textContent = Math.round((dayC*4)/totDay*100)+'%';

    card.querySelector('.day-cost').textContent = dayCost ? fmt(dayCost)+' z≈Ç' : '‚Äî';
    const pillCost = card.querySelector('.pill-cost');
    if(pillCost) pillCost.textContent = dayCost ? fmt(dayCost)+' z≈Ç' : '‚Äî';

    // statusy
    updateKcalStatus(card, dayK);
    updateMacroStatus(card, dayP, dayF, dayC);

    // wykres
    drawPie(card.querySelector('canvas'), [
      {label:'B', kcal:dayP*4},
      {label:'T', kcal:dayF*9},
      {label:'W', kcal:dayC*4}
    ]);
  });
}

/* ‚Äî‚Äî‚Äî Prosty wykres ko≈Çowy ‚Äî‚Äî‚Äî */
function drawPie(canvas, parts){
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const sum = parts.reduce((a,b)=>a+b.kcal,0) || 1;
  let start = -Math.PI/2;
  const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy)-6;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  parts.forEach((p,i)=>{
    const ang = (p.kcal/sum)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+ang);
    ctx.closePath();
    ctx.fillStyle = ['#94a3b8','#60a5fa','#fbbf24'][i%3];
    ctx.fill();
    start += ang;
  });
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
}

/* ============ ZAKUPY (podsumowanie tygodnia) ============ */
function renderShoppingForWeek(){
  const box = document.getElementById('shoppingListWrap');
  const pills = document.getElementById('shoppingWeeks');
  if(!box || !pills) return;

  pills.innerHTML = '';
  Object.keys(PLAN).forEach(k=>{
    const b = document.createElement('button');
    b.className='btn';
    b.textContent = PLAN[k].title;
    b.onclick = ()=> buildWeekList(k);
    pills.appendChild(b);
  });

  function buildWeekList(k){
    const prices = loadPrices();
    const map = {}; // {ingKey:{g,cost,label}}
    PLAN[k].days.forEach(d=>{
      if(d.shopping) return;
      Object.values(d.meals).forEach(items=>{
        (items||[]).forEach(it=>{
          const key = it.k;
          map[key] ||= {g:0, cost:0, label:(it.l||key)};
          map[key].g += it.g||0;
          map[key].cost += priceFor(key, it.g||0, prices);
        });
      });
    });

    const rows = Object.entries(map)
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([k,v])=>`
        <tr>
          <td>${k}</td>
          <td>${fmt(v.g)} g</td>
          <td>${v.cost? fmt(v.cost)+' z≈Ç':'‚Äî'}</td>
        </tr>`).join('');

    const total = Object.values(map).reduce((s,x)=>s+x.cost,0);
    box.innerHTML = `
      <div class="scroll">
        <table class="table">
          <thead class="thead"><tr><th>Produkt (klucz)</th><th>Ilo≈õƒá ≈ÇƒÖcznie</th><th>Szac. koszt</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot><tr class="sum-row"><td colspan="2"><b>RAZEM</b></td><td><b>${fmt(total)} z≈Ç</b></td></tr></tfoot>
        </table>
      </div>
    `;
  }
}

/* ============ Generowanie widok√≥w tygodni/dni ============ */
function renderWeeks(){
  const tabs = document.getElementById('weekTabs');
  const root = document.getElementById('weeksRoot');
  if(!tabs || !root) return;
  tabs.innerHTML = '';
  root.innerHTML = '';

  const weekKeys = Object.keys(PLAN);
  weekKeys.forEach((wk, wIndex)=>{
    const tab = document.createElement('button');
    tab.className = 'tab'+(wIndex===0?' active':'');
    tab.textContent = PLAN[wk].title || wk;
    tab.dataset.week = wk;
    tabs.appendChild(tab);

    const panel = document.createElement('div');
    panel.className = 'panel'+(wIndex===0?' active':'');
    panel.dataset.week = wk;

    const subtabs = document.createElement('div');
    subtabs.className = 'subtabs';
    panel.appendChild(subtabs);

    const days = PLAN[wk].days || [];
    days.forEach((day, dIndex)=>{
      if(day.shopping) return; // pomi≈Ñ pseudo-dzie≈Ñ "Zakupy_T*"
      const sub = document.createElement('button');
      sub.className = 'subtab'+(dIndex===0?' active':'');
      sub.textContent = day.day || ('Dzie≈Ñ '+(dIndex+1));
      sub.dataset.day = dIndex;
      subtabs.appendChild(sub);

      const card = document.createElement('div');
      card.className = 'card daycard'+(dIndex===0?' active':'');
      card.dataset.day = dIndex;
      card.innerHTML = renderDayTable(day, wk, dIndex);
      panel.appendChild(card);
    });

    root.appendChild(panel);
  });

  // prze≈ÇƒÖczanie tygodni
  tabs.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      root.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');
      const panel = root.querySelector(`.panel[data-week="${tab.dataset.week}"]`);
      if(panel){
        panel.classList.add('active');
        const activeSub = panel.querySelector('.subtab.active') || panel.querySelector('.subtab');
        if(activeSub) activeSub.click();
      }
    });
  });

  // prze≈ÇƒÖczanie dni (w aktywnym panelu)
  root.querySelectorAll('.panel').forEach(panel=>{
    const subs = panel.querySelectorAll('.subtab');
    subs.forEach(sub=>{
      sub.addEventListener('click', ()=>{
        subs.forEach(s=>s.classList.remove('active'));
        panel.querySelectorAll('.daycard').forEach(c=>c.classList.remove('active'));
        sub.classList.add('active');
        const target = panel.querySelector(`.daycard[data-day="${sub.dataset.day}"]`);
        if(target) target.classList.add('active');
      });
    });
    const first = subs[0];
    if(first) first.click();
  });
}

// (Usu≈Ñ tƒô wersjƒô funkcji renderWeeks)

/* ============ Filtr posi≈Çk√≥w (select) ============ */
function applyMealFilter(){
  const val = document.getElementById('mealFilter').value; // all | sniadanie | ...
  document.querySelectorAll('tr.tr-sec, tr.sum-row[data-sum]').forEach(tr=>{
    const sec = tr.getAttribute('data-sec') || tr.getAttribute('data-sum');
    const show = (val==='all') || (sec===val);
    tr.style.display = show ? '' : 'none';
  });
}
document.getElementById('mealFilter').addEventListener('change', applyMealFilter);

/* ============ Tryb ciemny ============ */
function _toggleDark(){ document.documentElement.classList.toggle('dark'); }

/* ============ Druk ============ */
function setPrintMode(mode){
  document.body.classList.remove('print-weekly','print-daily');
  if(mode==='weekly') document.body.classList.add('print-weekly');
  else if(mode==='daily') document.body.classList.add('print-daily');
  window.print();
}
/* ============ ‚Äû‚ö° Auto 2800‚Äù ‚Äì OLIWA ‚â§ 15 g + zdrowe t≈Çuszcze ============ */
/* ‚Äî cele i limity ‚Äî */
const AUTO_TARGET_KCAL = 2800;
const LIMITS = {
  oliwa: 15,              // g / dzie≈Ñ
  awokado: 100,           // g / dzie≈Ñ
  orzechy_wloskie: 30,    // g / dzie≈Ñ
  pestki_dyni: 30,        // g / dzie≈Ñ
  migdaly: 30             // g / dzie≈Ñ
};
// gƒôsto≈õci energetyczne (kcal / g), na podstawie NUTRI
const KCAL_PER_G = {
  oliwa: 8.84,
  awokado: 1.60,
  orzechy_wloskie: 6.54,
  pestki_dyni: 5.59,
  migdaly: 5.79
};
// kolejno≈õƒá ‚Äûdobijania‚Äù
const TOPUP_ORDER = ["oliwa","awokado","orzechy_wloskie","pestki_dyni","migdaly"];

/* ‚Äî pomocnicze: pobranie tablicy items z sekcji (obs≈Çuga formatu: {items:[]}) ‚Äî */
function _ensureMealSectionItems(meals, sectionName){
  const sec = meals[sectionName] || (meals[sectionName] = {items:[], kcal:0,b:0,w:0,t:0});
  if(!Array.isArray(sec.items)) sec.items = (sec.items && sec.items.items) ? sec.items.items : [];
  return sec.items;
}

/* ‚Äî zlicz ile gram danego klucza jest ju≈º w ca≈Çym dniu ‚Äî */
function gramsInDay(meals, key){
  let sum = 0;
  Object.values(meals).forEach(sec=>{
    const arr = (sec && sec.items) ? sec.items : (Array.isArray(sec) ? sec : []);
    (arr||[]).forEach(x=>{ if(x.k===key) sum += (x.g||0); });
  });
  return sum;
}

/* ‚Äî usu≈Ñ wcze≈õniejsze automaty (nie kumuluj) ‚Äî */
function purgeAutoAdditions(meals){
  const autoKeys = new Set(TOPUP_ORDER);
  Object.values(meals).forEach(sec=>{
    const arr = (sec && sec.items) ? sec.items : (Array.isArray(sec) ? sec : null);
    if(!arr) return;
    for(let i=arr.length-1;i>=0;i--){
      const it = arr[i];
      if(it && autoKeys.has(it.k) && it.auto) arr.splice(i,1);
    }
  });
}

/* ‚Äî policz makra/kcal dnia na podstawie NUTRI ‚Äî */
function getDayTotals(meals){
  let P=0,F=0,C=0;
  Object.values(meals).forEach(sec=>{
    const arr = (sec && sec.items) ? sec.items : (Array.isArray(sec) ? sec : []);
    (arr||[]).forEach(it=>{
      const nd = safeNutri(it.k);
      if(!nd) return;
      const r = (it.g||0)/100;
      P += (nd.p||0)*r;
      F += (nd.f||0)*r;
      C += (nd.c||0)*r;
    });
  });
  const kcal = Math.round(P*4 + F*9 + C*4);
  return {kcal,P,F,C};
}

/* ‚Äî dodaj/po≈ÇƒÖcz automatyczny sk≈Çadnik do sekcji (tu: kolacja) ‚Äî */
function addOrMergeAuto(meals, sectionName, key, grams, label){
  if(grams<=0) return;
  const items = _ensureMealSectionItems(meals, sectionName);
  const existing = items.find(x=>x.k===key && x.auto);
  if(existing){ existing.g += grams; }
  else{ items.push({k:key, g:grams, l:label, auto:true}); }
}

/* ‚Äî g≈Ç√≥wna funkcja: dobija do celu 2800 z limitami ‚Äî */
function autoTopUpDay(meals, targetKcal = AUTO_TARGET_KCAL){
  // 1) wyczy≈õƒá stare automaty
  purgeAutoAdditions(meals);

  // 2) ile brakuje?
  let {kcal} = getDayTotals(meals);
  let missing = targetKcal - kcal;
  if(missing <= 0) return; // nic nie dodajemy

  // 3) sekcja docelowa: kolacja (sta≈Ça w Twoim UI)
  const SECTION = "kolacja";
  _ensureMealSectionItems(meals, SECTION);

  // 4) przejd≈∫ po listach w ustalonej kolejno≈õci
  for(const key of TOPUP_ORDER){
    if(missing <= 0) break;

    const limit = LIMITS[key] || 0;
    const have = gramsInDay(meals, key);
    const room = Math.max(0, limit - have);
    if(room <= 0) continue;

    const kcalPerG = KCAL_PER_G[key] || 0;
    if(kcalPerG <= 0) continue;

    // ile gram potrzeba z tego produktu
    const needG = Math.ceil(missing / kcalPerG);      // zaokrƒÖglamy w g√≥rƒô
    const addG  = Math.min(room, needG);

    if(addG > 0){
      const niceLabel = {
        oliwa: 'Oliwa (auto)',
        awokado: 'Awokado (auto)',
        orzechy_wloskie: 'Orzechy w≈Çoskie (auto)',
        pestki_dyni: 'Pestki dyni (auto)',
        migdaly: 'Migda≈Çy (auto)'
      }[key] || (key+' (auto)');

      addOrMergeAuto(meals, SECTION, key, addG, niceLabel);
      missing -= addG * kcalPerG;
    }
  }
}

/* ‚Äî zastosuj do wszystkich dni w PLAN ‚Äî */
function autoDistributeAllDays(){
  Object.values(PLAN).forEach(week=>{
    week.days.forEach(d=>{
      if(d.shopping) return;
      autoTopUpDay(d.meals, AUTO_TARGET_KCAL);
    });
  });
}

document.getElementById('autoKcal').onclick = ()=>{
  autoDistributeAllDays();
  renderAll();
};

/* start po za≈Çadowaniu */
document.addEventListener('DOMContentLoaded', ()=> {
  // zainicjalizuj ceny z pamiƒôci i pierwsze renderowanie
  savePrices(); // upewnia siƒô, ≈ºe domy≈õlne trafiƒÖ do localStorage
  renderAll();
});
/* ============ Generator tabeli dnia (HTML) ============ */
function renderDayTable(dayObj, weekKey, dayIndex){
  if(dayObj.shopping){
    return `<div class="card daycard" data-week="${weekKey}" data-day="${dayObj.day}">
      <h2>${PLAN[weekKey].title} ‚Äì üõí Zakupy</h2>
      <div class="motto">‚Äû${dayObj.motto}‚Äù ‚Ä¢ Przejd≈∫ do sekcji <b>Podsumowanie zakup√≥w tygodniowych</b> poni≈ºej.</div>
      <div class="pills"><span class="pill">üßæ Zestawienie liczone z ca≈Çego tygodnia</span></div>
    </div>`;
  }

  const sections = ['sniadanie','drugie','obiad','kolacja','jogurt','podwieczorek'];
  const rows = [];

  sections.forEach(sec=>{
    const headerClass = sec==='sniadanie'?'sec-sniadanie':sec==='drugie'?'sec-drugie':sec==='obiad'?'sec-obiad':sec==='kolacja'?'sec-kolacja':'sec-jogurt';
    rows.push(`<tr class="tr-sec ${headerClass}" data-sec="${sec}"><th colspan="12">${MEAL_NAMES[sec]}</th></tr>`);
    const items = (dayObj.meals[sec] && dayObj.meals[sec].items) || dayObj.meals[sec] || [];

    (items||[]).forEach(item=>{
      const it = computeItem(item.k, item.g, item.l);
      if(!it){
        rows.push(`<tr data-sec="${sec}">
          <td>${MEAL_NAMES[sec].split(' ')[0]}</td>
          <td colspan="10" style="text-align:left;color:#b91c1c">
            Brak definicji produktu: <b>${item.k}</b> ‚Äî pozycja pominiƒôta w obliczeniach.
          </td>
          <td><span class="row-price" data-k="${item.k}" data-g="${item.g}"></span></td>
        </tr>`);
        return;
      }
      const kcalP = it.p*4, kcalF=it.f*9, kcalC=it.c*4;
      const pctP = pct(kcalP, it.kcal), pctF=pct(kcalF, it.kcal), pctC=pct(kcalC, it.kcal);
      rows.push(`<tr data-sec="${sec}">
        <td>${MEAL_NAMES[sec].split(' ')[0]}</td>
        <td>${item.l || item.k}</td>
        <td>${item.g}</td>
        <td>${it.brand||'-'}</td>
        <td class="kcal">${it.kcal}</td>
        <td class="p">${it.p.toFixed(1)}</td>
        <td class="f">${it.f.toFixed(1)}</td>
        <td class="c">${it.c.toFixed(1)}</td>
        <td class="pctp">${pctP}%</td>
        <td class="pctf">${pctF}%</td>
        <td class="pctc">${pctC}%</td>
        <td><span class="row-price" data-k="${item.k}" data-g="${item.g}"></span></td>
      </tr>`);
    });

    rows.push(`<tr class="sum-row" data-sum="${sec}">
      <td colspan="4"><b>SUMA ‚Äì ${MEAL_NAMES[sec]}</b></td>
      <td class="sum-kcal">0</td><td class="sum-p">0</td><td class="sum-f">0</td><td class="sum-c">0</td>
      <td class="sum-pctp"></td><td class="sum-pctf"></td><td class="sum-pctc"></td>
      <td class="sum-cost"></td>
    </tr>`);
  });

  rows.push(`<tr class="sum-row" data-sum="day">
    <td colspan="4"><b>‚úÖ SUMA DNIA</b></td>
    <td class="day-kcal">0</td><td class="day-p">0</td><td class="day-f">0</td><td class="day-c">0</td>
    <td class="day-pctp"></td><td class="day-pctf"></td><td class="day-pctc"></td>
    <td class="day-cost"></td>
  </tr>`);

  // checklist
  const checklist = [];
  Object.entries(dayObj.meals).forEach(([sec,secObjOrArr])=>{
    const arr = (secObjOrArr && secObjOrArr.items) || secObjOrArr || [];
    (arr||[]).forEach(it=>{
      const label = (it.l || it.k).replaceAll('_',' ');
      const id = `chk|${weekKey}|${dayObj.day}|${label}|${it.g}`;
      checklist.push(`<li><label><input type="checkbox" data-id="${id}"> ${label} ‚Äî <b>${it.g} g</b></label></li>`);
    });
  });

  return `
  <div class="card daycard" data-week="${weekKey}" data-day="${dayObj.day}">
    <h2>${PLAN[weekKey].title} ‚Äì ${dayObj.day}</h2>
    <div class="motto">‚Äû${dayObj.motto}‚Äù ‚Ä¢ Mi≈Çego dnia i smacznego! üòã</div>
    <div class="scroll">
      <table class="table">
        <thead class="thead">
          <tr><th>Posi≈Çek</th><th>Produkt</th><th>Gramatura (g)</th><th>Marka Lidl</th>
              <th>Kalorie</th><th>Bia≈Çko (g)</th><th>T≈Çuszcz (g)</th><th>Wƒôglowodany (g)</th>
              <th>% Bia≈Çko</th><th>% T≈Çuszcz</th><th>% Wƒôgle</th><th>Cena (szac.)</th></tr>
        </thead>
        <tbody>${rows.join('')}</tbody>
      </table>
    </div>
    <div class="chartWrap">
      <canvas width="200" height="200"></canvas>
      <div class="small">Wykres makro dnia (udzia≈Ç kcal %): bia≈Çko / t≈Çuszcz / wƒôglowodany.</div>
    </div>
    <div class="pills">
      <span class="pill cost">Koszt dnia: <b class="pill-cost">‚Ä¶</b></span>
      <span class="pill kcal"><b>üéØ Cel kcal: 2800</b> ‚Ä¢ <span class="kcal-status">‚Äî</span></span>
      <span class="pill macro"><b>üéØ Makro: 50/30/20</b> ‚Ä¢ <span class="macro-status">‚Äî</span></span>
      <span class="pill">‚úÖ Smacznego!</span>
      <span class="pill">üí™ Trzymaj rytm!</span>
    </div>
  </div>
  <div class="checklist">
    <h3>üõí Lista zakup√≥w na dzi≈õ</h3>
    <ul>${checklist.join('')}</ul>
  </div>`;
}
/* ============ KONIEC BLOKU ============ */
/* ---- Cele i tolerancje ---- */
const TARGET_KCAL = 2800;
// 50% t≈Ç, 30% wƒôgle, 20% bia≈Çko ‚Äì tak jak w UI
const TARGETS = { P:0.20, F:0.50, C:0.30 };
const TOLERANCE_KCAL = 100;
const TOL_PCT_PT = 3;

// --- Limity oliwy ---
const OIL_CAP = { perMeal: 5, perDay: 5 }; // max 5 g/posi≈Çek i 5 g/dzie≈Ñ (z menu + korekt)
const MAX_OIL_CORR_G = 3;                    // ‚Äûszlif‚Äù oliwƒÖ z autokorekty max 3 g

function gramsForMacroFromFood(foodKey, macro, targetDeltaKcal){
  const nd = NUTRI[foodKey]; if(!nd) return 0;
  const per100 = (macro==='P'? nd.p*4 : macro==='F'? nd.f*9 : nd.c*4);
  const perGram = per100/100;
  if(perGram<=0) return 0;
  // zaokrƒÖglamy do 5 g
  return Math.max(0, Math.round((targetDeltaKcal/perGram)/5)*5);
}
/* kcal/gram ‚Äì ga≈Çki do korekt */
const KCAL_PER_G_OLIWA = 9; // ~100% t≈Çuszczu

function gramsOfOliveFor(deltaKcalFat){
  // dodatnie => trzeba dodaƒá kcal z t≈Çuszczu
  const g = deltaKcalFat / KCAL_PER_G_OLIWA;
  return Math.max(0, Math.round(g/5)*5);
}

function updateMacroStatus(card, dayP, dayF, dayC){
  const pill = card.querySelector('.pill.macro');
  const box  = card.querySelector('.macro-status');
  if(!pill || !box) return;

  const pK = dayP*4, fK = dayF*9, cK = dayC*4;
  const tot = pK + fK + cK || 1;
  const pctP = Math.round((pK/tot)*100);
  const pctF = Math.round((fK/tot)*100);
  const pctC = Math.round((cK/tot)*100);

  pill.classList.remove('ok','warn','err');
  const off = Math.max(
    Math.abs(pctP - TARGETS.P*100),
    Math.abs(pctF - TARGETS.F*100),
    Math.abs(pctC - TARGETS.C*100)
  );
  if(off <= TOL_PCT_PT) pill.classList.add('ok');
  else if(off <= TOL_PCT_PT*2) pill.classList.add('warn');
  else pill.classList.add('err');

  // bardziej sensowne podpowiedzi
  const needFatKcal  = Math.max(0, TARGETS.F*TARGET_KCAL - fK);
  const needCarbKcal = Math.max(0, TARGETS.C*TARGET_KCAL - cK);
  const needProtKcal = Math.max(0, TARGETS.P*TARGET_KCAL - pK);

  const tips = [];
  if(needFatKcal){
    const gNuts = gramsForMacroFromFood('orzechy_wloskie','F', needFatKcal);
    tips.push((gNuts||10) + ' g orzech√≥w');
  }
  if(needCarbKcal){
    const gZboze = gramsForMacroFromFood('ryz_basmati_suchy','C', needCarbKcal);
    tips.push((gZboze||20) + ' g ry≈ºu (suchy)');
  }
  if(needProtKcal){
    const gTwr = gramsForMacroFromFood('twarog','P', needProtKcal);
    tips.push((gTwr||50) + ' g twarogu');
  }

  box.textContent = pctF + '% T ‚Ä¢ ' + pctC + '% W ‚Ä¢ ' + pctP + '% B' + (tips.length ? ' ‚Ä¢ dodaj: ' + tips.join(', ') : '');
}

function updateKcalStatus(card, dayK){
  const badge = card.querySelector('.kcal-status');
  const pill  = card.querySelector('.pill.kcal');
  if(!badge || !pill) return;
  const diff = Math.round(dayK - TARGET_KCAL); // dodatni = nadwy≈ºka
  pill.classList.remove('ok','warn','err');

  if(Math.abs(diff) <= TOLERANCE_KCAL){
    badge.textContent = 'jest OK (‚âà ' + Math.round(dayK) + ' kcal)';
    pill.classList.add('ok');
  }else if(diff < 0){
    const g = gramsOfOliveFor(-diff);
    badge.textContent = 'brakuje ' + (-diff) + ' kcal ‚Ä¢ dodaj ~' + g + ' g oliwy';
    pill.classList.add('warn');
  }else{
    const g = gramsOfOliveFor(diff);
    badge.textContent = 'nadwy≈ºka ' + diff + ' kcal ‚Ä¢ ujmij ~' + g + ' g oliwy';
    pill.classList.add('err');
  }
}
// G≈Ç√≥wna funkcja ‚Äì przeleci po wszystkich dniach i doda korektƒô
// (stara, b≈Çƒôdna implementacja usuniƒôta; poprawna wersja znajduje siƒô poni≈ºej)
// znacznik korekt
function _removeAutoCorrections(dayMeals){
  ['sniadanie','drugie','obiad','kolacja','jogurt','podwieczorek'].forEach(sec=>{
    if(!dayMeals[sec]) return;
    dayMeals[sec] = dayMeals[sec].filter(x => !x._autoCorr);
  });
}
function _calcDayKcal(dayMeals){
  let K=0;
  Object.values(dayMeals).forEach(items=>{
    (items||[]).forEach(it=>{
      const d = computeItem(it.k, it.g);
      if(d) K += d.kcal;
    });
  });
  return K;
}
function _calcDayMacros(dayMeals){
  let P=0,F=0,C=0;
  Object.values(dayMeals).forEach(items=>{
    (items||[]).forEach(it=>{
      const d = computeItem(it.k, it.g);
      if(d){ P+=d.p; F+=d.f; C+=d.c; }
    });
  });
  return {P,F,C};
}
// sumuje oliwƒô u≈ºyta w danym dniu
function _oilUsedInDay(dayMeals){
  let g=0;
  ['sniadanie','drugie','obiad','kolacja','jogurt'].forEach(sec=>{
    (dayMeals[sec]||[]).forEach(it=>{ if(it.k==='oliwa') g += (it.g||0); });
  });
  return g;
}
// przycina oliwƒô w istniejƒÖcym menu: max 5 g/posi≈Çek i max 10 g/dzie≈Ñ
function _capOliveOil(dayMeals){
  let left = OIL_CAP.perDay;
  ['sniadanie','drugie','obiad','kolacja','jogurt'].forEach(sec=>{
    (dayMeals[sec]||[]).forEach(it=>{
      if(it.k!=='oliwa') return;
      const allow = Math.min(OIL_CAP.perMeal, left);
      it.g = Math.max(0, Math.min(it.g||0, allow));
      left -= it.g;
    });
    dayMeals[sec] = (dayMeals[sec]||[]).filter(x=> (x.k!=='oliwa') || x.g>0);
  });
}
// ile oliwy mo≈ºna jeszcze dodaƒá, ≈ºeby nie z≈Çamaƒá limit√≥w
function _oilAllowanceLeft(dayMeals){
  const used = _oilUsedInDay(dayMeals);
  return Math.max(0, Math.min(OIL_CAP.perDay - used, OIL_CAP.perMeal));
}
// preferencje dobiegania makro ‚Äì priorytet: sta≈Çe produkty, r√≥≈ºnorodno≈õƒá
const TOPUP_PREF = {
  FAT:   { foods:['hummus','feta','orzechy_wloskie','migdaly','awokado'], secs:['drugie','kolacja'] },
  CARB:  { foods:['ryz_basmati_suchy','kuskus_suchy','platki_owsiane','chleb_zytni'], secs:['obiad','sniadanie','drugie'] },
  PROT:  { foods:['twarog','jajko','hummus'], secs:['kolacja','drugie','sniadanie'] },
  MIX:   { foods:['hummus','banan','chleb_zytni'], secs:['drugie','jogurt','sniadanie'] },
  OIL:   { foods:['oliwa'], secs:['kolacja'] }
};

// sensowne limity jednorazowych ‚Äûdobiƒá‚Äù (g)
const LIMITS_TOPUP = {
  hummus: 80,      // 1‚Äì2 ≈Çy≈ºki extra
  feta: 40,        // cienki plaster
  orzechy_wloskie: 30,
  migdaly: 25,
  awokado: 80,
  ryz_basmati_suchy: 60,
  kuskus_suchy: 60,
  platki_owsiane: 40,
  chleb_zytni: 60, // +1‚Äì2 kromki
  twarog: 150,
  jajko: 100,      // +1‚Äì2 jajka
  banan: 150,
  maslo_orzechowe: 30, // zostawiamy jako opcjƒô ‚Äûszybkiej energii‚Äù
  oliwa: 5
};
function clipG(k,g){ return Math.max(0, Math.min(g, LIMITS_TOPUP[k] ?? g)); }

function _pushCorrection(dayMeals, sec, k, g, label){
  (dayMeals[sec] ||= []).push({ k, g, l:label, _autoCorr:true });
}

function _smartTopUpDay(dayMeals){
  _removeAutoCorrections(dayMeals);
  // ---- helper: we≈∫ tablicƒô pozycji z sekcji (dzia≈Ça dla [..] i {items:[..]}) ----
function _getItemsRef(sec){
  if(!sec) return {type:'none', arr:[]};
  if(Array.isArray(sec)) return {type:'array', arr:sec};
  if(Array.isArray(sec.items)) return {type:'items', arr:sec.items};
  sec.items = [];           // ujednolicamy do {items:[]}
  return {type:'items', arr:sec.items};
}

// ---- usu≈Ñ wcze≈õniejsze auto-dodatki (nie wywalaj rƒôcznie obiektu sekcji) ----
function removeAutoCorrections(dayMeals){
  const autoKeys = new Set(["oliwa","awokado","orzechy_wloskie","pestki_dyni","migdaly"]);
  Object.keys(dayMeals).forEach(secName=>{
    const sec = dayMeals[secName];
    const {type, arr} = _getItemsRef(sec);
    const filtered = arr.filter(x => !(x && autoKeys.has(x.k) && x.auto));
    if(type==='array'){           // posi≈Çek by≈Ç tablicƒÖ
      dayMeals[secName] = filtered;
    }else if(type==='items'){     // posi≈Çek by≈Ç {items:[..]}
      sec.items = filtered;
    }
  });
}
  _capOliveOil(dayMeals);   // <<< przytnij oliwƒô z menu bazowego
  // 1) policz aktualne kcal i makra
  const curK = _calcDayKcal(dayMeals);
  let needK = Math.max(0, TARGET_KCAL - curK);
  const {P,F,C} = _calcDayMacros(dayMeals);
  let defF = Math.max(0, TARGETS.F*TARGET_KCAL - F*9);
  let defC = Math.max(0, TARGETS.C*TARGET_KCAL - C*4);
  let defP = Math.max(0, TARGETS.P*TARGET_KCAL - P*4);

  // pomocnicze dodawanie
  const add = (sec, food, g, label) => {
    if(g<=0) return 0;
    g = clipG(food, Math.round(g/5)*5); // zaokrƒÖglenie i limit
    if(g<=0) return 0;
    (dayMeals[sec] ||= []).push({k:food,g,l:label||food,_autoCorr:true});
    return computeItem(food,g)?.kcal || 0;
  };

  // 2) T≈ÅUSZCZE ‚Äì r√≥≈ºnorodne ≈∫r√≥d≈Ça
  if(defF > 0){
    needK -= add('drugie','hummus',40,'Korekta: hummus');
    needK -= add('kolacja','feta',25,'Korekta: feta');
    needK -= add('kolacja','orzechy_wloskie',15,'Korekta: orzechy');
  }

  // 3) WƒòGLE ‚Äì najpierw ry≈º/kuskus/chleb, potem banan
  if(defC > 0){
    needK -= add('obiad','ryz_basmati_suchy',50,'Korekta: ry≈º');
    needK -= add('obiad','kuskus_suchy',40,'Korekta: kuskus');
    needK -= add('sniadanie','chleb_zytni',40,'Korekta: chleb');
  }
  if(needK > 80){
    needK -= add('jogurt','banan',120,'Dodatek: banan do jogurtu');
  }

  // 4) BIA≈ÅKO ‚Äì twar√≥g / jajko
  if(defP > 0){
    needK -= add('kolacja','twarog',100,'Korekta: twar√≥g');
    needK -= add('sniadanie','jajko',50,'Korekta: jajko');
  }

  // 5) Mas≈Ço orzechowe jako szybka przekƒÖska
  if(needK > 120){
    needK -= add('drugie','maslo_orzechowe',20,'Korekta: mas≈Ço orzechowe');
  }

  // 6) Szlif oliwƒÖ ‚Äì tylko gdy trzeba i tylko w granicach
  if(needK > 0){
    const canAdd = _oilAllowanceLeft(dayMeals);              // ile jeszcze wolno
    const want   = Math.round(needK / 9);                    // teoretycznie potrzebne g
    const gOil   = Math.max(0, Math.min(MAX_OIL_CORR_G, canAdd, want));
    if(gOil>0){ _pushCorrection(dayMeals, 'kolacja', 'oliwa', gOil, 'Szlif: oliwa'); }
  }
}

function autoTopUpAllDays(){
  Object.values(PLAN).forEach(week=>{
    week.days.forEach(d=>{
      if(d.shopping) return;
      _smartTopUpDay(d.meals);
    });
  });
}

/* ============ FILTR POSI≈ÅK√ìW (globalny) ============ */
function applyMealFilter(){
  const val = document.getElementById('mealFilter').value;
  document.querySelectorAll('.daycard').forEach(card=>{
    card.querySelectorAll('tr[data-sec], .tr-sec').forEach(row=>{
      const sec = row.getAttribute('data-sec');
      row.style.display = (val==='all' || val===sec) ? '' : 'none';
    });
  });
}

/* ============ SUMY / KOSZTY / CHECKLISTY ============ */
const CHK_KEY = 'emil_checklist_v1';
function loadChecklist(){ try{ return JSON.parse(localStorage.getItem(CHK_KEY)||'{}') }catch(e){ return {} } }
function saveChecklist(map){ localStorage.setItem(CHK_KEY, JSON.stringify(map)); }
function wireChecklist(){
  const state = loadChecklist();
  document.querySelectorAll('.checklist input[type="checkbox"]').forEach(cb=>{
    const id = cb.getAttribute('data-id');
    cb.checked = !!state[id];
    cb.addEventListener('change', ()=>{
      const s = loadChecklist();
      if(cb.checked) s[id]=true; else delete s[id];
      saveChecklist(s);
    });
  });
}

function recalcCostsAndSums(){
  const prices = loadPrices();

  document.querySelectorAll('.daycard').forEach(card=>{
    let dayCost=0, dayK=0, dayP=0, dayF=0, dayC=0;

    // ceny w wierszach
    card.querySelectorAll('.row-price').forEach(sp=>{
      const k = sp.getAttribute('data-k');
      const g = parseFloat(sp.getAttribute('data-g'))||0;
      const cost = priceFor(k,g,prices);
      sp.textContent = fmt(cost) + ' z≈Ç';
    });

    // sumy posi≈Çk√≥w
    ['sniadanie','drugie','obiad','kolacja','jogurt'].forEach(sec=>{
      let K=0,P=0,F=0,C=0,cost=0;
      card.querySelectorAll('tr[data-sec="' + sec + '"]').forEach(tr=>{
        const kcal = parseFloat((tr.querySelector('.kcal') && tr.querySelector('.kcal').textContent) || 0);
        const p = parseFloat((tr.querySelector('.p') && tr.querySelector('.p').textContent) || 0);
        const f = parseFloat((tr.querySelector('.f') && tr.querySelector('.f').textContent) || 0);
        const c = parseFloat((tr.querySelector('.c') && tr.querySelector('.c').textContent) || 0);
        const rp = (tr.querySelector('.row-price') && tr.querySelector('.row-price').textContent) || '0';
        const czl = parseFloat((rp.match(/[\d.]+/)||['0'])[0])||0;
        K+=kcal; P+=p; F+=f; C+=c; cost+=czl;
      });
      const sumRow = card.querySelector('.sum-row[data-sum="' + sec + '"]');
      if(sumRow){
        sumRow.querySelector('.sum-kcal').textContent = Math.round(K);
        sumRow.querySelector('.sum-p').textContent = P.toFixed(1);
        sumRow.querySelector('.sum-f').textContent = F.toFixed(1);
        sumRow.querySelector('.sum-c').textContent = C.toFixed(1);
        const pK=P*4, fK=F*9, cK=C*4, tot=pK+fK+cK;
        sumRow.querySelector('.sum-pctp').textContent = (tot?Math.round(pK/tot*100):0)+'%';
        sumRow.querySelector('.sum-pctf').textContent = (tot?Math.round(fK/tot*100):0)+'%';
        sumRow.querySelector('.sum-pctc').textContent = (tot?Math.round(cK/tot*100):0)+'%';
        sumRow.querySelector('.sum-cost').textContent = fmt(cost) + ' z≈Ç';
      }
      dayK+=K; dayP+=P; dayF+=F; dayC+=C; dayCost+=cost;
    });

    const dayRow = card.querySelector('.sum-row[data-sum="day"]');
    if(dayRow){
      dayRow.querySelector('.day-kcal').textContent = Math.round(dayK);
      dayRow.querySelector('.day-p').textContent = dayP.toFixed(1);
      dayRow.querySelector('.day-f').textContent = dayF.toFixed(1);
      dayRow.querySelector('.day-c').textContent = dayC.toFixed(1);
      const pK=dayP*4, fK=dayF*9, cK=dayC*4, tot=pK+fK+cK;
      dayRow.querySelector('.day-pctp').textContent = (tot?Math.round(pK/tot*100):0)+'%';
      dayRow.querySelector('.day-pctf').textContent = (tot?Math.round(fK/tot*100):0)+'%';
      dayRow.querySelector('.day-pctc').textContent = (tot?Math.round(cK/tot*100):0)+'%';
      dayRow.querySelector('.day-cost').textContent = fmt(dayCost) + ' z≈Ç';
    }
    const pill = card.querySelector('.pill-cost');
    if(pill) pill.textContent = fmt(dayCost) + ' z≈Ç';

    // aktualizuj statusy i wykresy dla tej karty
    updateKcalStatus(card, dayK);
    updateMacroStatus(card, dayP, dayF, dayC);
  });
}

/* ============ WYKRES KO≈ÅOWY (vanilla canvas) ============ */
function drawPie(canvas, vals){
  const ctx = canvas.getContext('2d');
  const total = vals.reduce((a,b)=>a+b,0) || 1;
  const colors = ['#60a5fa','#34d399','#fbbf24']; // P, F, C
  let start= -Math.PI/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-4;
  vals.forEach((v,i)=>{
    const ang = (v/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+ang); ctx.closePath();
    ctx.fillStyle=colors[i%colors.length]; ctx.fill();
    start+=ang;
  });
  // bia≈Çy ≈õrodek
  ctx.beginPath(); ctx.arc(cx,cy,r*0.5,0,Math.PI*2); ctx.fillStyle='white'; ctx.fill();
  // obw√≥dka
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.stroke();
}
function drawAllCharts(){
  document.querySelectorAll('.daycard').forEach(card=>{
    const row = card.querySelector('.sum-row[data-sum="day"]');
    if(!row) return;
    const P = parseFloat(row.querySelector('.day-p')?.textContent||0)*4;
    const F = parseFloat(row.querySelector('.day-f')?.textContent||0)*9;
    const C = parseFloat(row.querySelector('.day-c')?.textContent||0)*4;
    const canvas = card.querySelector('canvas');
    if(canvas) drawPie(canvas, [P,F,C]);
  });
}

/* ============ ZAKUPY ‚Äì agregacja tygodniowa ============ */
function buildShoppingForWeek(weekKey){
  const prices = loadPrices();
  const map = {}; // {ingKey: grams}
  const week = PLAN[weekKey];
  if(!week) return {list:[], total:0};

  week.days.forEach(d=>{
    if(d.shopping) return;
    Object.values(d.meals).forEach(items=>{
      (items||[]).forEach(it=>{
        map[it.k] = (map[it.k]||0) + it.g;
      });
    });
  });
/* ============ ZAKUPY ‚Äì storage ============ */
const SHOP_STORE_KEY = 'emil_shop_v1';

function loadShopDB(){
  try{ return JSON.parse(localStorage.getItem(SHOP_STORE_KEY)) || {}; }
  catch(e){ return {}; }
}
function saveShopDB(db){
  try{ localStorage.setItem(SHOP_STORE_KEY, JSON.stringify(db)); }catch(e){}
}
function getWeekShopState(weekKey){
  const db = loadShopDB();
  return db[weekKey] || {};
}
function setWeekShopState(weekKey, state){
  const db = loadShopDB();
  db[weekKey] = state;
  saveShopDB(db);
}

/* aktywny tydzie≈Ñ na podstawie otwartego panelu */
function getActiveWeekKey(){
  return document.querySelector('.panel.active')?.dataset.week || Object.keys(PLAN)[0];
}

  const list = Object.entries(map).map(([k,g])=>{
    const cost = priceFor(k,g,prices);
    const brand = NUTRI[k]?.brand || '-';
    const label = k.replaceAll('_',' ');
    return {k,label,brand,g,cost};
  }).sort((a,b)=> a.label.localeCompare(b.label,'pl'));

  const total = list.reduce((s,x)=>s+x.cost,0);
  return {list,total};
}
function renderShoppingBar(){
  const wrap = document.getElementById('shoppingWeeks');
  const out = document.getElementById('shoppingListWrap');
  wrap.innerHTML='';
  out.innerHTML='<div class="small">Wybierz tydzie≈Ñ, aby zobaczyƒá szczeg√≥≈Çy‚Ä¶</div>';
  Object.keys(PLAN).forEach(wk=>{
    const b = document.createElement('button');
    b.className='btn';
    b.textContent = PLAN[wk].title;
    b.addEventListener('click', ()=>{
      const {list,total} = buildShoppingForWeek(wk);
      const rows = list.map(function(it){
        return '<tr><td>' + it.label + '</td><td>' + it.brand + '</td><td style="text-align:right">' + it.g + '</td><td style="text-align:right">' + fmt(it.cost) + ' z≈Ç</td></tr>';
      }).join('');
      out.innerHTML = '<div class="scroll">' +
        '<table class="table">' +
          '<thead class="thead"><tr><th>Produkt</th><th>Marka</th><th>Gramatura (g)</th><th>Koszt</th></tr></thead>' +
          '<tbody>' + rows + '</tbody>' +
          '<tfoot><tr class="sum-row"><td colspan="3" style="text-align:right"><b>Razem</b></td><td><b>' + fmt(total) + ' z≈Ç</b></td></tr></tfoot>' +
        '</table>' +
      '</div>';
    });
    wrap.appendChild(b);
  });
}

/* ============ ZAKUPY ‚Äì podpowied≈∫ opakowa≈Ñ i kategorie ============ */
function packHint(ingKey, grams){
  const nd = NUTRI[ingKey] || {};
  // sztuki (jajka/awokado)
  if(nd.pricePerUnit && nd.unit === 'szt'){
    const unitG = nd.unitGram || 1;
    const pcs = Math.ceil(grams / unitG);
    return pcs + ' √ó szt. (~' + Math.round(grams) + ' g)';
  }
  // znane opakowanie (np. hummus 180 g, jogurt 200 g, mix 450 g)
  if(nd.packed){
    const packs = Math.ceil(grams / nd.packed);
    const left = grams % nd.packed;
    return packs + ' √ó ' + nd.packed + ' g' + (left ? ' (ok. ' + Math.round(grams) + ' g)' : '');
  }
  // oliwa (z≈Ç/l) ‚Äì liczymy jak kg
  if(nd.priceKey === 'oliwa_extra_vergine_l_1'){
    const ml = grams; // traktujemy 1 ml ~= 1 g do koszyka
    if(ml >= 1000){ 
      const b = (ml/1000).toFixed(2);
      return '~' + b + ' l (wg potrzeb)';
    }
    return '~' + ml + ' ml (wg potrzeb)';
  }
  // domy≈õlnie produkty ‚Äûna wagƒô‚Äù
  if(grams >= 1000){
    return '~' + (grams/1000).toFixed(2) + ' kg';
  }
  return '~' + Math.round(grams) + ' g';
}

function categorize(ingKey){
  const map = {
    bialko:['dorsz','mintaj','losos','indyk','kurczak','jajko','twarog','feta','jogurt2','hummus'],
    zboza:['chleb_zytni','platki_owsiane','kasza_gryczana_sucha','ryz_basmati_suchy','kuskus_suchy'],
    tluszcze:['oliwa','orzechy_wloskie','migdaly','pestki_dyni','awokado','feta'],
    warzywa:['papryka','ogorek','pomidor','cebula','marchew','mix_mroz','brokul','kalafior'],
    inne:[/* fallback */]
  };
  for(const [cat,arr] of Object.entries(map)){
    if(arr.includes(ingKey)) return cat;
  }
  return 'inne';
}

/* ============ ZAKUPY ‚Äì widok w ka≈ºdym tygodniu (rozsuwane <details>) ============ */
function renderInlineWeekShopping(){
  document.querySelectorAll('.panel').forEach(panel=>{
    const wk = panel.dataset.week;
    if(!wk || !PLAN[wk]) return;

    // upewnij siƒô, ≈ºe mamy kontener na listƒô zakup√≥w dla tego panelu
    let holder = panel.querySelector('.week-shopping-card');
    if(!holder){
      holder = document.createElement('div');
      holder.className = 'card week-shopping-card';
      holder.innerHTML = '<h2>üßæ Zakupy ‚Äì ' + PLAN[wk].title + '</h2><div class="scroll"></div>';
      panel.appendChild(holder);
    }
    const target = holder.querySelector('.scroll');

    const {list,total} = buildShoppingForWeek(wk);
    function buildShoppingForWeek(weekKey){
  // ...tu liczysz agregacje produkt√≥w i sumƒô...
  const state = getWeekShopState(weekKey);   // üëà odczyt zapisanych zmian

  let rows = '';
  // Za≈Ç√≥≈ºmy, ≈ºe masz tablicƒô pozycji: items = [{key, label, grams, cost}, ...]
  items.forEach(it=>{
    const saved = state[it.key] || {};
    const checked = saved.checked ?? false;
    const grams = saved.grams ?? it.grams;

    rows += `
      <tr data-key="${it.key}">
        <td style="text-align:left">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" class="shop-check" data-key="${it.key}" ${checked?'checked':''}>
            <span>${it.label || it.key}</span>
          </label>
        </td>
        <td>
          <input type="number" class="shop-qty" data-key="${it.key}" min="0" step="1" value="${grams}">
          g
        </td>
        <td class="cost">${fmt(it.cost)} z≈Ç</td>
      </tr>`;
  });

  const html = `
    <div class="scroll">
      <table class="table">
        <thead class="thead"><tr><th>Produkt</th><th>Ilo≈õƒá</th><th>Szac. koszt</th></tr></thead>
        <tbody>${rows}</tbody>
        <tfoot><tr class="sum-row"><td colspan="2"><b>RAZEM</b></td><td><b>${fmt(total)} z≈Ç</b></td></tr></tfoot>
      </table>
    </div>
    <div class="printbar" style="padding:8px 12px">
      <button class="btn" id="btnClearShop">üßπ Wyzeruj stan dla tego tygodnia</button>
    </div>
  `;

  const out = document.getElementById('shoppingListWrap');
  out.innerHTML = html;
}

    // grupowanie po kategoriach
    const byCat = {};
    list.forEach(it=>{
      const cat = categorize(it.k);
      (byCat[cat] || (byCat[cat]=[])).push(it);
    });

    const catLabel = {
      bialko:'Bia≈Çka / nabia≈Ç / strƒÖczki',
      zboza:'Pieczywo / zbo≈ºa / kasze',
      tluszcze:'T≈Çuszcze / orzechy / pestki',
      warzywa:'Warzywa / mro≈ºonki',
      inne:'Inne'
    };

    // budowa sekcji per kategoria (collapsible)
    let html = '';
    Object.keys(catLabel).forEach(cat=>{
      const items = byCat[cat] || [];
      if(!items.length) return;
      const rows = items.map(it=>{
        const hint = packHint(it.k, it.g);
        return `
          <tr>
            <td>${it.label}</td>
            <td>${(NUTRI[it.k]?.brand)||'-'}</td>
            <td style="text-align:right">${Math.round(it.g)}</td>
            <td style="text-align:right">${hint}</td>
            <td style="text-align:right">${fmt(it.cost)} z≈Ç</td>
          </tr>`;
      }).join('');
      html += `
        <details open>
          <summary style="padding:8px 12px;font-weight:700;cursor:pointer">${catLabel[cat]}</summary>
          <div class="scroll" style="margin:0 12px 10px">
            <table class="table">
              <thead class="thead">
                <tr>
                  <th>Produkt</th><th>Marka</th>
                  <th style="text-align:right">Gramatura (g)</th>
                  <th style="text-align:right">Opakowania / waga</th>
                  <th style="text-align:right">Koszt</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </details>`;
    });

    html += `
      <div style="padding:8px 12px;border-top:1px dashed var(--br);display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="pill">üí∞ Razem: <b>${fmt(total)} z≈Ç</b></span>
      </div>`;

    target.innerHTML = html;
  });
}

/* ============ DRUK ============ */
function syncPrintContext(){
  document.body.classList.remove('print-mode-day','print-mode-week','print-mode-shopping');
}
function setupPrintButtons(){
  const autoBtn = document.getElementById('autoKcal');
  if(autoBtn) autoBtn.addEventListener('click', ()=>{
    autoTopUpAllDays();
    renderAll(); // przerysuj ca≈Çy widok z nowymi gramaturami
  });

  const pDay  = document.getElementById('pDay');
  const pWeek = document.getElementById('pWeek');
  const pShop = document.getElementById('pShop');
  const pAll  = document.getElementById('pAll');

  if(pDay) pDay.addEventListener('click', ()=>{
    document.body.classList.add('print-mode-day');
    window.print();
    document.body.classList.remove('print-mode-day');
  });
  if(pWeek) pWeek.addEventListener('click', ()=>{
    document.body.classList.add('print-mode-week');
    window.print();
    document.body.classList.remove('print-mode-week');
  });
  if(pShop) pShop.addEventListener('click', ()=>{
    document.body.classList.add('print-mode-shopping');
    window.print();
    document.body.classList.remove('print-mode-shopping');
  });
  if(pAll) pAll.addEventListener('click', ()=>{
    syncPrintContext(); window.print();
  });
}

/* ============ MOTYW CIEMNY ============ */
function _toggleDark(){
  const root = document.documentElement;
  const isDark = root.classList.toggle('dark');
  try{ localStorage.setItem('emil_dark', isDark?'1':'0'); }catch(e){}
}
(function(){
  try{
    if(localStorage.getItem('emil_dark')==='1'){
      document.documentElement.classList.add('dark');
    }
  }catch(e){}
})();
document.getElementById('shoppingListWrap').addEventListener('input', (e)=>{
  const wk = getActiveWeekKey();
  const state = getWeekShopState(wk);

  if(e.target.matches('.shop-qty')){
    const k = e.target.dataset.key;
    const grams = Math.max(0, parseFloat(e.target.value) || 0);
    state[k] = { ...(state[k]||{}), grams, checked: state[k]?.checked ?? false };
    setWeekShopState(wk, state);
    // (opcjonalnie) przelicz koszt pozycji i sumƒô RAZEM po zmianie grams
    // recomputeShoppingRowAndTotal(wk, k, grams);
  }
});

document.getElementById('shoppingListWrap').addEventListener('change', (e)=>{
  const wk = getActiveWeekKey();
  const state = getWeekShopState(wk);

  if(e.target.matches('.shop-check')){
    const k = e.target.dataset.key;
    const checked = e.target.checked;
    state[k] = { ...(state[k]||{}), checked, grams: state[k]?.grams ?? undefined };
    setWeekShopState(wk, state);
  }
});

// przycisk resetu dla tygodnia
document.getElementById('shoppingListWrap').addEventListener('click', (e)=>{
  if(e.target.id === 'btnClearShop'){
    const wk = getActiveWeekKey();
    setWeekShopState(wk, {});                    // wyczy≈õƒá zapis
    buildShoppingForWeek(wk);                    // odtw√≥rz domy≈õlne ilo≈õci
  }
});

/* ============ RENDER CA≈ÅO≈öCI ============ */
// (remove this duplicate definition)

/* ============ INIT ============ */
// ---- RENDER ALL (SUMY + WYKRESY + FILTR) ----
function renderAll(){
  renderWeeks();            // buduje karty dni/tygodni
  computeSumsAndPrices();   // liczy kcal/makra/koszty + rysuje ko≈Ço
  applyMealFilter();        // ustawia filtr z selecta
}
document.addEventListener('DOMContentLoaded', ()=>{
  // Schowaj cennik na ma≈Çych ekranach
  if (window.matchMedia('(max-width: 560px)').matches) {
    document.getElementById('priceDetails')?.removeAttribute('open');
  }
  // za≈Çaduj ceny do tabeli (z localStorage)
  const saved = loadPrices();
  // je≈ºeli co≈õ siƒô r√≥≈ºni ‚Äì nadpisz widok
  document.querySelectorAll('#priceTable tbody tr').forEach(tr=>{
    const key = tr.getAttribute('data-key');
    const td = tr.querySelector('.pval');
    if(key in saved && td) td.textContent = String(saved[key]);
  });

  // Korekty makro i renderowanie
  if (typeof autoTopUpAllDays === 'function') autoTopUpAllDays();
  renderAll();
    renderShoppingForWeek();                               // zbuduj pigu≈Çki tygodni + handler
  document.querySelector('#shoppingWeeks .btn')?.click(); // od razu poka≈º listƒô 1. tygodnia

  setupPrintButtons();

  const mf = document.getElementById('mealFilter');
  if(mf) mf.addEventListener('change', applyMealFilter);
});
// ======= Mobilne udogodnienia =======
function _toggleScrollShadows(){
  document.querySelectorAll('.scroll').forEach(el=>{
    const max = el.scrollWidth - el.clientWidth - 1;
    el.classList.toggle('show-left', el.scrollLeft>0);
    el.classList.toggle('show-right', el.scrollLeft<max);
  });
}
window.addEventListener('resize', _toggleScrollShadows);
_toggleScrollShadows();

// aktywne ‚Äûdni‚Äù przewijajƒÖ siƒô w obrƒôbie paska subtabs
// Usuniƒôto powielonƒÖ definicjƒô funkcji _centerActiveSubtab
// aktywne ‚Äûdni‚Äù przewijajƒÖ siƒô w obrƒôbie paska subtabs
function _centerActiveSubtab(){
  document.querySelectorAll('.panel').forEach(panel=>{
    const bar = panel.querySelector('.subtabs');
    const active = panel.querySelector('.subtab.active');
    if(!bar || !active) return;
    const aRect = active.getBoundingClientRect();
    const bRect = bar.getBoundingClientRect();
    const delta = (aRect.left + aRect.width/2) - (bRect.left + bRect.width/2);
    bar.scrollBy({left: delta, behavior:'smooth'});
  });
}
// 4) Liczenie cen i sum + wykres + statusy
function drawPie(canvas, p, f, c){
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const kcalP = p * 4, kcalF = f * 9, kcalC = c * 4;
  const total = Math.max(1, kcalP + kcalF + kcalC);
  const parts = [kcalP, kcalF, kcalC];
  const cx = canvas.width / 2, cy = canvas.height / 2, r = Math.min(cx, cy) - 4;
  let start = -Math.PI / 2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  parts.forEach((val, i) => {
    const ang = (val / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, start + ang);
    ctx.closePath();
    ctx.fillStyle = ['#60a5fa','#34d399','#fbbf24'][i % 3];
    ctx.fill();
    start += ang;
  });
  // subtle ring
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.stroke();
}

// global meal filter wiring (uses existing applyMealFilter implementation)
document.getElementById('mealFilter')?.addEventListener('change', applyMealFilter);

// print buttons (safe wiring in case handlers were not attached elsewhere)
document.getElementById('pDay')?.addEventListener('click', ()=>{ document.body.classList.add('print-mode-day'); window.print(); document.body.classList.remove('print-mode-day'); });
document.getElementById('pWeek')?.addEventListener('click', ()=>{ document.body.classList.add('print-mode-week'); window.print(); document.body.classList.remove('print-mode-week'); });
document.getElementById('pShop')?.addEventListener('click', ()=>{ document.body.classList.add('print-mode-shopping'); window.print(); document.body.classList.remove('print-mode-shopping'); });
document.getElementById('pAll')?.addEventListener('click', ()=>{ window.print(); });

// autoKcal button
document.getElementById('autoKcal')?.addEventListener('click', ()=>{ autoTopUpAllDays(); renderAll(); });

// minimal shopping pills initializer (uses existing buildShoppingForWeek / renderShoppingBar)
function initShoppingPills(){
  const wrap = document.getElementById('shoppingWeeks');
  const out  = document.getElementById('shoppingListWrap');
  if(!wrap || !out) return;
  wrap.innerHTML = '';
  Object.keys(PLAN).forEach((wk,i)=>{
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = PLAN[wk].title;
    b.addEventListener('click', ()=> {
      const {list,total} = buildShoppingForWeek(wk);
      const rows = list.map(it=> '<tr><td>' + it.label + '</td><td>' + (it.brand||'-') + '</td><td style="text-align:right">' + Math.round(it.g) + '</td><td style="text-align:right">' + fmt(it.cost) + ' z≈Ç</td></tr>').join('');
      out.innerHTML = '<div class="scroll"><table class="table"><thead class="thead"><tr><th>Produkt</th><th>Marka</th><th>Gramatura (g)</th><th>Koszt</th></tr></thead><tbody>' + rows + '</tbody><tfoot><tr class="sum-row"><td colspan="3" style="text-align:right"><b>Razem</b></td><td><b>' + fmt(total) + ' z≈Ç</b></td></tr></tfoot></table></div>';
    });
    wrap.appendChild(b);
    if(i===0) b.click();
  });
}

// start rendering (keep existing functions' calls)
renderAll();
/* ‚Äî‚Äî‚Äî Prosty wykres ko≈Çowy ‚Äî‚Äî‚Äî */
function drawPie(canvas, parts){
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const sum = parts.reduce((a,b)=>a+b.kcal,0) || 1;
  let start = -Math.PI/2;
  const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy)-6;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  parts.forEach((p,i)=>{
    const ang = (p.kcal/sum)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+ang);
    ctx.closePath();
    ctx.fillStyle = ['#94a3b8','#60a5fa','#fbbf24'][i%3]; // kolory B/T/W
    ctx.fill();
    start += ang;
  });
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
}
// start ‚Äì pojedynczy render po za≈Çadowaniu DOM
document.addEventListener('DOMContentLoaded', ()=>{

  /* ============ Generowanie widok√≥w tygodni/dni ============ */

  // przycisk ‚ÄûZakupy‚Äù pod spodem
  renderShoppingForWeek();
});

/* (opcjonalnie ‚Äì tylko je≈õli nie masz ju≈º tej funkcji w pliku)
*/

// przycisk ‚Äû‚ö° Auto 2800‚Äù ju≈º masz ‚Äì zostaje bez zmian
// document.getElementById('autoKcal').onclick = ()=>{ autoDistributeAllDays(); renderAll(); };

</script>
</body>
</html>  
